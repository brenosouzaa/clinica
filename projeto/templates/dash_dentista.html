<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Painel Médico | Exclusive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .day-check:checked + div { 
            background-color: #ef4444; color: #fff; border-color: #ef4444;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.5); transform: translateY(-2px);
        }
        .radio-card:checked + div {
            border-color: #bf9b30; background-color: #fffbeb; color: #bf9b30;
            transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .fade-out { animation: fadeOut 1s forwards; animation-delay: 5s; }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; visibility: hidden; } }
        .input-locked { background: transparent; border: none; font-weight: 600; color: #374151; }
        .input-editable { background: #fff; border: 1px solid #e5e7eb; padding: 0.5rem; }
        .input-editable:focus { border-color: #bf9b30; outline: none; }
        .timeline-line { position: absolute; left: 24px; top: 0; bottom: 0; width: 2px; background: #e5e7eb; z-index: 0; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        body { padding-bottom: 90px; background-color: #f8fafc; } 
        /* Estilo para bloqueio visual */
        .blocked-input { background-color: #e5e7eb !important; color: #9ca3af !important; cursor: not-allowed; border-color: #d1d5db; }
    </style>
</head>
<body class="font-sans text-gray-800 flex flex-col md:flex-row min-h-screen">

    <aside class="w-64 bg-white shadow-xl z-20 hidden md:flex flex-col fixed inset-y-0 left-0 h-full border-r border-gray-100 overflow-y-auto">
        <div class="flex-1">
            <div class="p-8 text-center border-b border-gray-50">
                <h1 class="font-serif text-xl font-bold tracking-widest text-gray-900">L'ODONTOLOGIE</h1>
                <p class="text-[10px] text-[#bf9b30] uppercase tracking-[0.3em] mt-1 font-bold">Specialist</p>
            </div>
            <div class="p-6 text-center">
                <div class="relative w-20 h-20 mx-auto mb-3">
                    <img src="{{ current_user.foto_perfil }}" class="w-full h-full rounded-full object-cover border-[3px] gold-border shadow-xl">
                </div>
                <p class="font-serif font-bold text-base text-gray-800">Dr(a). {{ current_user.nome }}</p>
                <p class="text-xs text-gray-400 uppercase tracking-wide mt-1">{{ current_user.especialidade or 'Dentista' }}</p>
            </div>
            <nav class="mt-2 px-4 space-y-1 pb-6">
                <a onclick="showTab('agenda')" class="cursor-pointer block p-3 text-sm font-bold text-gray-500 hover:text-black hover:bg-gray-50 rounded-lg transition flex items-center gap-3 desktop-link tab-active"><i class="fas fa-calendar-check w-6"></i> Minha Agenda</a>
                <a onclick="showTab('atendimento')" class="cursor-pointer block p-3 text-sm font-bold text-gray-500 hover:text-black hover:bg-gray-50 rounded-lg transition flex items-center gap-3 desktop-link"><i class="fas fa-stethoscope w-6"></i> Sala de Atendimento</a>
                <a onclick="showTab('historico')" class="cursor-pointer block p-3 text-sm font-bold text-gray-500 hover:text-black hover:bg-gray-50 rounded-lg transition flex items-center gap-3 desktop-link"><i class="fas fa-history w-6"></i> Histórico Geral</a>
                <a onclick="showTab('agendar')" class="cursor-pointer block p-3 text-sm font-bold text-gray-500 hover:text-black hover:bg-gray-50 rounded-lg transition flex items-center gap-3 desktop-link"><i class="fas fa-user-plus w-6"></i> Novo Paciente</a>
                <a onclick="showTab('emergencia')" class="cursor-pointer block p-3 text-sm font-bold text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition flex items-center gap-3 desktop-link"><i class="fas fa-ban w-6"></i> Bloqueio</a>
                <a onclick="showTab('portfolio')" class="cursor-pointer block p-3 text-sm font-bold text-gray-500 hover:text-black hover:bg-gray-50 rounded-lg transition flex items-center gap-3 desktop-link"><i class="fas fa-camera w-6"></i> Portfólio</a>
                <a onclick="showTab('perfil')" class="cursor-pointer block p-3 text-sm font-bold text-gray-500 hover:text-black hover:bg-gray-50 rounded-lg transition flex items-center gap-3 desktop-link"><i class="fas fa-user-md w-6"></i> Meu Perfil</a>
            </nav>
        </div>
        <div class="p-6 border-t border-gray-50 mt-auto">
            <a href="/logout" class="block w-full text-center py-2 text-xs font-bold text-red-400 hover:text-red-600 border border-red-100 hover:bg-red-50 rounded-lg transition tracking-widest">DESCONECTAR</a>
        </div>
    </aside>

    <div class="md:hidden bg-white/90 backdrop-blur-md p-4 shadow-sm flex justify-between items-center sticky top-0 z-40 border-b border-gray-100">
        <div class="flex items-center gap-3">
            <img src="{{ current_user.foto_perfil }}" class="w-10 h-10 rounded-full border border-gray-200 object-cover shadow-sm">
            <div><p class="text-[10px] text-[#bf9b30] font-bold uppercase tracking-widest">Painel Médico</p><p class="text-sm font-bold leading-none">{{ current_user.nome.split()[0] }}</p></div>
        </div>
        <a href="/logout" class="text-gray-400 hover:text-red-500"><i class="fas fa-sign-out-alt text-lg"></i></a>
    </div>

    <main class="flex-1 md:ml-64 p-4 md:p-12 max-w-[1600px] mx-auto w-full flex flex-col min-h-screen">
        
        {% if erro %}<div class="fade-out fixed top-6 right-6 z-50 bg-white border-l-4 border-red-500 text-red-700 p-4 rounded-xl shadow-2xl flex items-center gap-3"><i class="fas fa-times-circle text-xl"></i><div><p class="font-bold text-sm">Atenção</p><p class="text-xs">{{ erro }}</p></div></div>{% endif %}
        {% if sucesso %}<div class="fade-out fixed top-6 right-6 z-50 bg-white border-l-4 border-green-500 text-green-800 p-4 rounded-xl shadow-2xl flex items-center gap-3"><i class="fas fa-check-circle text-xl"></i><div><p class="font-bold text-sm">Sucesso</p><p class="text-xs">{{ sucesso }}</p></div></div>{% endif %}

        <div id="agenda" class="tab-content">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-serif font-bold text-gray-900">Gestão de Agenda</h2>
                <div class="text-right">
                    <p class="text-xs text-gray-400 uppercase tracking-widest">Data de Hoje</p>
                    <p class="font-bold text-lg" id="data-atual-display">Carregando...</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-8 rounded-3xl shadow-sm border border-gray-100 h-fit">
                    <div class="flex items-center gap-3 mb-6 border-b border-gray-50 pb-4">
                        <span class="w-3 h-3 rounded-full bg-green-500 shadow-green-500/50 shadow-lg"></span>
                        <h3 class="font-bold text-gray-800 tracking-wide">ATENDIMENTOS HOJE</h3>
                        <span class="ml-auto bg-gray-100 text-xs font-bold px-2 py-1 rounded-md text-gray-500">{{ agenda_hoje|length }}</span>
                    </div>
                    <div class="space-y-6">
                        {% for item in agenda_hoje %}
                        <div class="relative bg-white border border-gray-100 p-6 rounded-2xl shadow-sm hover:shadow-md transition group w-full {% if item.tipo_consulta == 'Avaliação' %} border-l-4 border-l-[#bf9b30] {% else %} border-l-4 border-l-gray-300 {% endif %}">
                            <div class="flex items-start justify-between mb-4 gap-3">
                                <div class="flex items-center gap-4 flex-1 min-w-0">
                                    <img src="{{ item.paciente.foto_perfil }}" class="w-14 h-14 rounded-full object-cover border-2 border-white shadow-sm bg-gray-100 shrink-0">
                                    <div class="min-w-0">
                                        <p class="font-bold text-sm text-gray-900 leading-tight truncate">{{ item.paciente.nome }}</p>
                                        <p class="text-[10px] text-gray-400 uppercase font-bold mt-1">{{ item.tipo_consulta }}</p>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end shrink-0">
                                    <span class="text-xl font-bold text-gray-800 font-serif">{{ item.data_hora.strftime('%H:%M') }}</span>
                                    <span class="mt-1 px-3 py-1 rounded-full text-[9px] font-bold uppercase tracking-wider text-center whitespace-nowrap {{ 'bg-yellow-100 text-yellow-700' if item.status == 'Agendado' else 'bg-green-100 text-green-700' }}">{{ item.status }}</span>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg mb-4"><p class="text-xs text-gray-600 font-medium"><i class="fas fa-tooth text-[#bf9b30] mr-1"></i> {{ item.servico }}</p></div>
                            
                            <div class="flex flex-col gap-2 mt-2">
                                {% if item.status == 'Em Andamento' %}
                                    <a href="?tab=atendimento&id_paciente={{ item.paciente_id }}" class="w-full bg-green-500 text-white py-2 rounded-lg font-bold text-xs uppercase hover:bg-green-600 transition shadow-lg animate-pulse text-center">Retomar Atendimento</a>
                                {% elif item.status == 'Concluído' %}
                                    <span class="w-full bg-gray-100 text-gray-400 py-2 rounded-lg text-xs font-bold text-center">Atendimento Finalizado</span>
                                {% else %}
                                    <div class="grid grid-cols-2 gap-2">
                                        <form method="POST" class="w-full"><input type="hidden" name="acao" value="iniciar_consulta"><input type="hidden" name="id_agendamento" value="{{ item.id }}"><button class="w-full bg-black text-white py-2.5 rounded-lg font-bold text-[10px] uppercase hover:bg-[#bf9b30] transition shadow">INICIAR</button></form>
                                        <form method="POST" class="w-full" onsubmit="return confirm('Marcar como não compareceu?')"><input type="hidden" name="acao" value="nao_compareceu"><input type="hidden" name="id_agendamento" value="{{ item.id }}"><button class="w-full bg-red-50 text-red-500 py-2.5 rounded-lg font-bold text-[10px] uppercase hover:bg-red-100 transition whitespace-nowrap">NÃO COMPARECEU</button></form>
                                    </div>
                                    <form method="POST" onsubmit="return confirm('Cancelar consulta de hoje?')"><input type="hidden" name="acao" value="cancelar_consulta"><input type="hidden" name="id_agendamento" value="{{ item.id }}"><button class="w-full py-2 bg-gray-50 text-gray-400 rounded-lg hover:bg-red-500 hover:text-white transition text-[10px] font-bold uppercase border border-gray-100 mt-1">Cancelar</button></form>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center py-10 opacity-50"><i class="far fa-calendar-check text-4xl text-gray-300 mb-2"></i><p class="text-xs font-bold text-gray-400">Tudo livre por hoje.</p></div>
                        {% endfor %}
                    </div>
                </div>

                <div class="bg-white p-8 rounded-3xl shadow-sm border border-gray-100 h-fit opacity-90">
                    <div class="flex items-center gap-3 mb-6 border-b border-gray-50 pb-4"><span class="w-3 h-3 rounded-full bg-blue-400"></span><h3 class="font-bold text-gray-800 tracking-wide">AMANHÃ</h3><span id="count-amanha" class="ml-auto bg-gray-100 text-xs font-bold px-2 py-1 rounded-md text-gray-500">0</span></div>
                    <div id="lista-amanha" class="space-y-4"><div class="text-center py-10 opacity-50 empty-msg"><p class="text-xs font-bold text-gray-400">Sem agendamentos.</p></div></div>
                </div>

                <div class="lg:col-span-2 bg-white p-8 rounded-3xl shadow-sm border border-gray-100 h-fit opacity-75">
                    <div class="flex items-center gap-3 mb-6 border-b border-gray-50 pb-4"><span class="w-3 h-3 rounded-full bg-gray-300"></span><h3 class="font-bold text-gray-800 tracking-wide">FUTURO</h3><span id="count-futuro" class="ml-auto bg-gray-100 text-xs font-bold px-2 py-1 rounded-md text-gray-500">0</span></div>
                    <div id="lista-futuro" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"><div class="text-center py-10 opacity-50 empty-msg col-span-full"><p class="text-xs font-bold text-gray-400">Agenda futura livre.</p></div></div>
                </div>
                
                 <div id="dados-futuros" class="hidden">
                    {% for item in agenda_futura %}
                    <div class="agenda-item relative bg-white border border-gray-100 p-4 rounded-2xl shadow-sm" data-date="{{ item.data_hora.strftime('%Y-%m-%d') }}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-3">
                                <img src="{{ item.paciente.foto_perfil }}" class="w-10 h-10 rounded-full object-cover bg-gray-100">
                                <div><p class="font-bold text-sm">{{ item.paciente.nome.split()[0] }}</p><p class="text-[10px] text-gray-400">{{ item.data_hora.strftime('%d/%m') }} às {{ item.data_hora.strftime('%H:%M') }}</p></div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div id="atendimento" class="tab-content hidden">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-3xl font-serif font-bold">Sala de Atendimento</h2>
                <form method="GET" class="flex gap-2 w-full md:w-auto">
                    <input type="hidden" name="tab" value="atendimento">
                    <select name="id_paciente" class="bg-white border border-gray-200 p-2 rounded-lg text-sm outline-none focus:border-[#bf9b30] w-full md:w-auto" onchange="this.form.submit()">
                        <option value="">-- Selecionar Paciente da Agenda --</option>
                        {% for item in agenda_hoje %}
                        <option value="{{ item.paciente_id }}" {{ 'selected' if paciente_atendimento and paciente_atendimento.id == item.paciente_id }}>{{ item.data_hora.strftime('%H:%M') }} - {{ item.paciente.nome }}</option>
                        {% endfor %}
                    </select>
                </form>
            </div>

            {% if paciente_atendimento %}
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full pb-20">
                <div class="lg:col-span-1 space-y-6 overflow-y-auto pr-2" style="max-height: 80vh;">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 text-center">
                        <img src="{{ paciente_atendimento.foto_perfil }}" class="w-24 h-24 rounded-full mx-auto mb-4 object-cover border-4 border-gray-50">
                        <h3 class="font-bold text-xl">{{ paciente_atendimento.nome }}</h3>
                        <p class="text-xs text-[#bf9b30] font-bold tracking-widest uppercase mt-1 mb-2">PRONTUÁRIO: #{{ '%05d' % paciente_atendimento.id }}</p>
                        <p class="text-sm text-gray-500">{{ paciente_atendimento.telefone }}</p>
                        <p class="text-xs text-gray-400 mt-1">{{ paciente_atendimento.email }}</p>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h4 class="font-bold text-[#bf9b30] uppercase tracking-widest text-xs mb-6">Histórico Clínico</h4>
                        <div class="relative space-y-8 pl-4">
                            <div class="timeline-line"></div>
                            {% for h in historico_paciente %}
                                <div class="relative z-10">
                                    <div class="w-4 h-4 rounded-full bg-[#bf9b30] border-4 border-white shadow absolute -left-[23px] top-1"></div>
                                    <p class="text-xs font-bold text-gray-400 mb-1">{{ h.data_hora.strftime('%d/%m/%Y') }} - {{ h.servico }}</p>
                                    {% if h.prontuario %}
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm border-l-2 border-[#bf9b30] mb-2">
                                        <p class="font-bold text-[10px] uppercase text-gray-400">Queixa:</p><p class="mb-2 text-xs">{{ h.prontuario.queixa }}</p>
                                        <p class="font-bold text-[10px] uppercase text-gray-400">Procedimento:</p><p class="mb-2 text-xs">{{ h.prontuario.procedimento }}</p>
                                        <p class="font-bold text-[10px] uppercase text-gray-400">Evolução:</p><p class="text-gray-600 text-xs">{{ h.prontuario.evolucao }}</p>
                                    </div>
                                    {% else %}
                                    <p class="text-xs text-gray-300 italic mb-2">Sem prontuário detalhado.</p>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    {% set consulta_atual = historico_paciente|selectattr("status", "equalto", "Em Andamento")|first %}
                    {% if consulta_atual %}
                        <div class="bg-white p-8 rounded-2xl shadow-lg border border-[#bf9b30]/20 h-full flex flex-col">
                            <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                                <div><h3 class="text-2xl font-serif font-bold text-green-600 flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></span> Em Atendimento</h3><p class="text-sm text-gray-500">{{ consulta_atual.servico }}</p></div>
                                <div class="text-right"><p class="text-xs font-bold uppercase text-gray-400">Início</p><p class="font-mono text-xl">{{ consulta_atual.data_hora.strftime('%H:%M') }}</p></div>
                            </div>
                            <form method="POST" class="flex-1 flex flex-col gap-4">
                                <input type="hidden" name="acao" value="finalizar_consulta"><input type="hidden" name="id_agendamento" value="{{ consulta_atual.id }}">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="text-[10px] font-bold uppercase text-gray-400">Queixa Principal</label><textarea name="queixa" class="input-editable w-full h-24 rounded-lg" placeholder="O que o paciente relatou?"></textarea></div>
                                    <div><label class="text-[10px] font-bold uppercase text-gray-400">Procedimento</label><textarea name="procedimento" class="input-editable w-full h-24 rounded-lg" placeholder="O que foi feito?"></textarea></div>
                                </div>
                                <div><label class="text-[10px] font-bold uppercase text-gray-400">Evolução</label><textarea name="evolucao" class="input-editable w-full h-20 rounded-lg" placeholder="Detalhes..."></textarea></div>
                                <div><label class="text-[10px] font-bold uppercase text-gray-400">Próximos Passos</label><input type="text" name="proximos_passos" class="input-editable w-full rounded-lg"></div>

                                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 mt-2">
                                    <p class="text-xs font-bold text-blue-600 uppercase mb-2"><i class="fas fa-calendar-plus mr-1"></i> Agendar Retorno (Opcional)</p>
                                    <div class="flex gap-4">
                                        <input type="date" name="retorno_data" id="data_retorno_sala" onchange="atualizarHorarios('data_retorno_sala', 'hora_retorno_sala')" class="input-editable bg-white rounded-lg">
                                        <select name="retorno_hora" id="hora_retorno_sala" class="input-editable bg-white rounded-lg">
                                            <option value="">-- Hora --</option><option value="08:00">08:00</option><option value="09:00">09:00</option><option value="10:00">10:00</option><option value="11:00">11:00</option><option value="14:00">14:00</option><option value="15:00">15:00</option><option value="16:00">16:00</option><option value="17:00">17:00</option>
                                        </select>
                                    </div>
                                    <p class="text-[10px] text-blue-400 mt-1">*Mínimo 2h de antecedência (Só para hoje).</p>
                                </div>
                                <button class="mt-auto bg-black text-white w-full py-4 rounded-xl font-bold uppercase tracking-widest hover:bg-[#bf9b30] transition shadow-lg">Finalizar Atendimento & Salvar Prontuário</button>
                            </form>
                        </div>
                    {% else %}
                        <div class="bg-white p-10 rounded-2xl shadow-sm border border-gray-100 text-center h-full flex flex-col justify-center items-center opacity-60">
                            <i class="fas fa-user-clock text-6xl text-gray-200 mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-400">Paciente Selecionado</h3>
                            <p class="text-sm text-gray-400 mb-6">Este paciente não tem uma consulta "Em Andamento" agora.</p>
                            {% set consulta_hoje = historico_paciente|selectattr("status", "equalto", "Confirmado")|first %}
                            {% if not consulta_hoje %}{% set consulta_hoje = historico_paciente|selectattr("status", "equalto", "Agendado")|first %}{% endif %}
                            
                            {% if consulta_hoje and consulta_hoje.data_hora.date() == date.today() %} 
                                <form method="POST"><input type="hidden" name="acao" value="iniciar_consulta"><input type="hidden" name="id_agendamento" value="{{ consulta_hoje.id }}"><button class="bg-green-500 text-white px-8 py-3 rounded-lg font-bold hover:bg-green-600 transition">Iniciar Consulta Agendada</button></form>
                            {% else %}
                                <p class="text-xs text-gray-400">Para atender, vá na aba "Agenda Hoje" e clique em INICIAR.</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="flex items-center justify-center h-96 text-gray-400 flex-col"><i class="fas fa-hand-pointer text-4xl mb-4 opacity-30"></i><p>Selecione um paciente na lista acima ou inicie pela Agenda.</p></div>
            {% endif %}
        </div>

        <div id="historico" class="tab-content hidden">
            <h2 class="text-3xl font-serif font-bold mb-6">Histórico Geral</h2>
            <form method="GET" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-8 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <input type="hidden" name="tab" value="historico">
                <div class="md:col-span-2"><label class="text-[10px] font-bold uppercase text-gray-400">Buscar (Nome, Email ou Tel)</label><input type="text" name="busca_geral" placeholder="Digite para buscar..." class="input-editable w-full rounded-lg"></div>
                <div>
                    <label class="text-[10px] font-bold uppercase text-gray-400">Filtrar por Ano</label>
                    <select name="filtro_ano" id="filtro_ano" onchange="atualizarFiltroMeses()" class="input-editable w-full rounded-lg">
                        <option value="">Todos</option><option value="2025">2025</option><option value="2026">2026</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-bold uppercase text-gray-400">Mês</label>
                    <select name="filtro_mes" id="filtro_mes" class="input-editable w-full rounded-lg">
                        <option value="">Todos</option><option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Março</option><option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option><option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option><option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
                    </select>
                </div>
                <div class="md:col-span-1"><label class="text-[10px] font-bold uppercase text-gray-400">Data Específica</label><input type="date" name="filtro_data" class="input-editable w-full rounded-lg"></div>
                <div class="md:col-span-3 flex justify-end"><button class="bg-black text-white px-8 py-2.5 rounded-lg font-bold text-xs uppercase hover:bg-[#bf9b30] transition w-full md:w-auto"><i class="fas fa-filter mr-2"></i> Filtrar Resultados</button></div>
            </form>
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse min-w-[800px]">
                        <thead class="bg-gray-50 text-gray-400 text-[10px] uppercase font-bold tracking-widest"><tr><th class="p-4">Data</th><th class="p-4">Paciente</th><th class="p-4">Contato</th><th class="p-4">Status</th><th class="p-4 text-right">Ação</th></tr></thead>
                        <tbody class="text-sm">
                            {% for h in historico_geral %}
                            <tr class="border-b border-gray-50 hover:bg-gray-50 transition">
                                <td class="p-4 font-mono font-bold">{{ h.data_hora.strftime('%d/%m/%Y %H:%M') }}</td>
                                <td class="p-4">{{ h.paciente.nome }}</td>
                                <td class="p-4 text-xs text-gray-500">{{ h.paciente.email }}<br>{{ h.paciente.telefone }}</td>
                                <td class="p-4"><span class="px-2 py-1 rounded text-[10px] font-bold uppercase {{ 'bg-green-100 text-green-600' if h.status == 'Concluído' else 'bg-gray-100 text-gray-500' }}">{{ h.status }}</span></td>
                                <td class="p-4 text-right"><a href="?tab=atendimento&id_paciente={{ h.paciente.id }}" class="bg-black text-white text-xs font-bold px-4 py-2 rounded-lg hover:bg-[#bf9b30] transition">Abrir Ficha</a></td>
                            </tr>
                            {% else %}
                            <tr><td colspan="5" class="p-8 text-center text-gray-400">Nenhum registro encontrado.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="agendar" class="tab-content hidden">
            <h2 class="text-3xl font-serif font-bold mb-2">Novo Agendamento</h2>
            <p class="text-sm text-gray-500 mb-8">Selecione o motivo da consulta.</p>
            <form method="POST" class="max-w-5xl mx-auto">
                <input type="hidden" name="acao" value="agendar">
                <p class="text-xs font-bold uppercase text-gray-400 mb-4 tracking-wider">Qual o motivo da visita?</p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <label class="cursor-pointer group"><input type="radio" name="servico" value="Avaliação Geral" class="hidden radio-card" required checked><div class="border-2 border-gray-100 bg-white p-4 rounded-2xl text-center hover:border-gray-300 transition group-hover:shadow-lg h-full flex flex-col items-center justify-center gap-3"><i class="fas fa-clipboard-list text-2xl text-gray-300 group-hover:text-[#bf9b30] transition"></i><span class="text-xs font-bold text-gray-600 group-hover:text-black">Avaliação</span></div></label>
                    <label class="cursor-pointer group"><input type="radio" name="servico" value="Dor / Urgência" class="hidden radio-card"><div class="border-2 border-gray-100 bg-white p-4 rounded-2xl text-center hover:border-gray-300 transition group-hover:shadow-lg h-full flex flex-col items-center justify-center gap-3"><i class="fas fa-first-aid text-2xl text-gray-300 group-hover:text-red-500 transition"></i><span class="text-xs font-bold text-gray-600 group-hover:text-black">Urgência</span></div></label>
                    <label class="cursor-pointer group"><input type="radio" name="servico" value="Estética" class="hidden radio-card"><div class="border-2 border-gray-100 bg-white p-4 rounded-2xl text-center hover:border-gray-300 transition group-hover:shadow-lg h-full flex flex-col items-center justify-center gap-3"><i class="fas fa-gem text-2xl text-gray-300 group-hover:text-blue-500 transition"></i><span class="text-xs font-bold text-gray-600 group-hover:text-black">Estética</span></div></label>
                    <label class="cursor-pointer group"><input type="radio" name="servico" value="Ortodontia" class="hidden radio-card"><div class="border-2 border-gray-100 bg-white p-4 rounded-2xl text-center hover:border-gray-300 transition group-hover:shadow-lg h-full flex flex-col items-center justify-center gap-3"><i class="fas fa-teeth text-2xl text-gray-300 group-hover:text-gray-600 transition"></i><span class="text-xs font-bold text-gray-600 group-hover:text-black">Ortodontia</span></div></label>
                </div>
                
                <div class="bg-white p-8 rounded-3xl shadow-xl border border-gray-100">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
                        <div><label class="block text-xs font-bold uppercase text-gray-400 mb-2">Busca (Email ou Tel)</label><input type="text" name="termo_busca" id="termo_busca" required class="w-full bg-gray-50 border-2 border-gray-100 text-xl font-bold p-3 rounded-xl focus:border-[#bf9b30] outline-none"></div>
                        <div><label class="block text-xs font-bold uppercase text-gray-400 mb-2">Nome (Se novo paciente)</label><input type="text" name="nome_paciente" class="w-full bg-white border-2 border-gray-100 text-xl p-3 rounded-xl focus:border-[#bf9b30] outline-none"></div>
                    </div>
                    <div class="md:col-span-2 grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-xl mb-6">
                        <div>
                            <label class="block text-xs font-bold uppercase text-gray-400 mb-2">Clínica</label>
                            <select name="clinica_id_agendamento" id="clinica_agendamento" onchange="filtrarMedicosAgendamento()" class="w-full bg-white border border-gray-200 text-sm rounded-lg p-3 outline-none">
                                <option value="">Selecione...</option>
                                {% for c in clinicas %}<option value="{{ c.id }}">{{ c.nome }}</option>{% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-gray-400 mb-2">Médico Responsável</label>
                            <select name="dentista_selecionado" id="dentista_agendamento" onchange="verificarDisponibilidade()" class="w-full bg-white border border-gray-200 text-sm rounded-lg p-3 outline-none">
                                <option value="">Selecione Clínica...</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div><label class="block text-xs font-bold uppercase text-gray-400 mb-2">Data</label><input type="date" name="data_dia" id="data_dia_agendamento" onchange="atualizarHorarios('data_dia_agendamento', 'data_hora_agendamento')" required class="w-full bg-white border border-gray-200 text-sm rounded-lg p-3 focus:border-[#bf9b30] outline-none"></div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-gray-400 mb-2">Horário (2h+)</label>
                            <select name="data_hora" id="data_hora_agendamento" class="w-full bg-white border border-gray-200 text-sm rounded-lg p-3 focus:border-[#bf9b30] outline-none">
                                <option value="08:00">08:00</option><option value="09:00">09:00</option><option value="10:00">10:00</option><option value="11:00">11:00</option><option value="13:00">13:00</option><option value="14:00">14:00</option><option value="15:00">15:00</option><option value="16:00">16:00</option><option value="17:00">17:00</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-gray-400 mb-2">Tipo de Consulta</label>
                            <select name="tipo_consulta" class="w-full bg-white border border-gray-200 text-sm rounded-lg p-3 focus:border-[#bf9b30] outline-none">
                                <option value="Avaliação">Avaliação</option><option value="Tratamento">Tratamento</option><option value="Retorno">Retorno</option>
                            </select>
                        </div>
                    </div>
                    <button class="w-full bg-black text-white py-4 rounded-xl font-bold uppercase tracking-widest shadow-xl hover:bg-[#bf9b30] transition transform active:scale-[0.99]">Confirmar Agendamento</button>
                </div>
            </form>
        </div>

        <div id="emergencia" class="tab-content hidden">
            {% if pendentes_aviso %}
            <div class="mb-10 bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-r-xl shadow-sm animate-pulse">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-lg font-bold text-yellow-800"><i class="fas fa-exclamation-triangle mr-2"></i> Pacientes Aguardando Aviso</h3>
                        <p class="text-sm text-yellow-700 mt-1">Consultas canceladas por bloqueio. Avise-os e marque como resolvido.</p>
                    </div>
                </div>
                <div class="mt-4 space-y-3">
                    {% for p in pendentes_aviso %}
                    <div class="flex items-center justify-between bg-white p-4 rounded-lg shadow-sm">
                        <div>
                            <p class="font-bold text-sm">{{ p.paciente.nome }}</p>
                            <p class="text-xs text-gray-500">{{ p.data_hora.strftime('%d/%m às %H:%M') }}</p>
                        </div>
                        <div class="flex gap-2">
                             {% if p.paciente.telefone %}
                             {% set tel = p.paciente.telefone|limpar_telefone %}
                             <a href="https://wa.me/55{{ tel }}?text=Olá {{ p.paciente.nome }}, sua consulta do dia {{ p.data_hora.strftime('%d/%m às %H:%M') }} precisou ser cancelada devido a um imprevisto na agenda. Por favor, entre em contato para reagendarmos." target="_blank" class="bg-green-500 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-green-600 transition"><i class="fab fa-whatsapp"></i> Avisar</a>
                             {% endif %}
                             <form method="POST">
                                 <input type="hidden" name="acao" value="marcar_como_avisado">
                                 <input type="hidden" name="id_agendamento" value="{{ p.id }}">
                                 <button class="bg-gray-200 text-gray-600 px-3 py-2 rounded-lg text-xs font-bold hover:bg-gray-300 transition" title="Remover da lista"><i class="fas fa-check"></i></button>
                             </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="max-w-5xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden border border-gray-100 flex flex-col md:flex-row h-auto mt-6">
                <div class="w-full md:w-1/2 bg-gray-50 p-10 border-r border-gray-100">
                    <div class="mb-6"><i class="fas fa-calendar-times text-4xl text-gray-300"></i></div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Folga Fixa Semanal</h3>
                    <p class="text-sm text-gray-500 mb-6 leading-relaxed">Selecione os dias da semana em que a agenda ficará fechada recorrentemente.</p>
                    <form method="POST" id="form-folga-semanal" class="space-y-4">
                        <input type="hidden" name="acao" value="bloqueio_semanal">
                        <div class="grid grid-cols-2 gap-3 mb-6">
                            {% set dias_ativos = current_user.dia_folga_semanal.split(',') if current_user.dia_folga_semanal else [] %}
                            <label class="cursor-pointer group"><input type="checkbox" name="dia_semana" value="0" class="hidden day-check" {{ 'checked' if '0' in dias_ativos }}><div class="border border-gray-200 rounded-lg py-3 text-center text-xs font-bold uppercase text-gray-400 group-hover:border-red-400 group-hover:text-red-400 transition bg-white select-none">Segunda</div></label>
                            <label class="cursor-pointer group"><input type="checkbox" name="dia_semana" value="1" class="hidden day-check" {{ 'checked' if '1' in dias_ativos }}><div class="border border-gray-200 rounded-lg py-3 text-center text-xs font-bold uppercase text-gray-400 group-hover:border-red-400 group-hover:text-red-400 transition bg-white select-none">Terça</div></label>
                            <label class="cursor-pointer group"><input type="checkbox" name="dia_semana" value="2" class="hidden day-check" {{ 'checked' if '2' in dias_ativos }}><div class="border border-gray-200 rounded-lg py-3 text-center text-xs font-bold uppercase text-gray-400 group-hover:border-red-400 group-hover:text-red-400 transition bg-white select-none">Quarta</div></label>
                            <label class="cursor-pointer group"><input type="checkbox" name="dia_semana" value="3" class="hidden day-check" {{ 'checked' if '3' in dias_ativos }}><div class="border border-gray-200 rounded-lg py-3 text-center text-xs font-bold uppercase text-gray-400 group-hover:border-red-400 group-hover:text-red-400 transition bg-white select-none">Quinta</div></label>
                            <label class="cursor-pointer group"><input type="checkbox" name="dia_semana" value="4" class="hidden day-check" {{ 'checked' if '4' in dias_ativos }}><div class="border border-gray-200 rounded-lg py-3 text-center text-xs font-bold uppercase text-gray-400 group-hover:border-red-400 group-hover:text-red-400 transition bg-white select-none">Sexta</div></label>
                            <label class="cursor-pointer group"><input type="checkbox" name="dia_semana" value="5" class="hidden day-check" {{ 'checked' if '5' in dias_ativos }}><div class="border border-gray-200 rounded-lg py-3 text-center text-xs font-bold uppercase text-gray-400 group-hover:border-red-400 group-hover:text-red-400 transition bg-white select-none">Sábado</div></label>
                        </div>
                        <div class="flex gap-3"><button type="submit" class="flex-1 bg-black text-white py-3 rounded-lg font-bold text-xs uppercase hover:bg-gray-800 transition shadow-lg tracking-widest">Salvar</button><button type="submit" name="operacao" value="limpar" class="flex-1 bg-white border border-red-200 text-red-400 py-3 rounded-lg font-bold text-xs uppercase hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition tracking-widest"> Desativar Folgas</button></div>  
                    </form>
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <p class="text-[10px] font-bold uppercase text-gray-400 mb-2 tracking-widest">Status Atual:</p>
                        {% if current_user.dia_folga_semanal %}
                        <div class="flex flex-wrap gap-2">
                            {% for d in dias_ativos %}
                                <span class="bg-red-50 text-red-600 px-3 py-1 rounded-full text-[10px] font-bold uppercase border border-red-100 shadow-sm">{% if d=='0' %}Segunda{% elif d=='1' %}Terça{% elif d=='2' %}Quarta{% elif d=='3' %}Quinta{% elif d=='4' %}Sexta{% elif d=='5' %}Sábado{% else %}Domingo{% endif %}</span>
                            {% endfor %}
                        </div>
                        <p class="text-[9px] text-gray-400 mt-2 font-bold"><i class="fas fa-lock mr-1"></i> Agenda bloqueada nestes dias.</p>
                        {% else %}
                        <p class="text-xs text-green-600 italic font-bold"><i class="fas fa-check-circle mr-1"></i> Agenda aberta (Sem folgas fixas).</p>
                        {% endif %}
                    </div>
                </div>

                <div class="w-full md:w-1/2 p-10 bg-white">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 rounded-full bg-red-50 flex items-center justify-center text-xl text-red-500 shadow-sm"><i class="fas fa-ban"></i></div>
                        <h3 class="text-xl font-bold text-red-600 tracking-wide">Bloquear Data Específica</h3>
                    </div>
                    <form method="POST" class="mb-8">
                        <input type="hidden" name="acao" value="bloqueio">
                        <div class="mb-4"><label class="block text-xs font-bold uppercase text-gray-400 mb-2">Selecione a Data</label><input type="date" name="data_bloqueio" id="data_bloqueio_input" required class="w-full border-b-2 border-gray-200 py-2 text-lg font-bold text-gray-800 focus:border-red-500 outline-none transition"></div>
                        <div class="mb-6"><label class="block text-xs font-bold uppercase text-gray-400 mb-2">Motivo</label><input type="text" name="motivo" placeholder="Ex: Viagem, Feriado..." class="w-full border-b-2 border-gray-200 py-2 text-sm mb-6 outline-none transition focus:border-red-500"></div>
                        <button class="w-full bg-red-600 text-white py-3 rounded-lg font-bold text-xs uppercase shadow-lg hover:bg-red-700 transition tracking-widest">Bloquear Dia Inteiro</button>
                    </form>
                    <div>
                        <h4 class="text-[10px] font-bold uppercase text-gray-400 mb-3 tracking-widest border-b border-gray-100 pb-2">Histórico de Bloqueios</h4>
                        <div class="max-h-64 overflow-y-auto pr-2 scrollbar-hide space-y-2">
                            {% for f in folgas %}
                            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg group hover:bg-white hover:shadow-md transition border border-transparent hover:border-gray-100">
                                <div><p class="text-sm font-bold text-gray-700 font-mono">{{ f.data.strftime('%d/%m/%Y') }}</p><p class="text-[9px] text-gray-400 uppercase font-bold">{{ f.motivo }}</p></div>
                                <form method="POST"><input type="hidden" name="acao" value="excluir_bloqueio"><input type="hidden" name="id_bloqueio" value="{{ f.id }}"><button class="w-8 h-8 rounded-full bg-white border border-gray-200 text-gray-300 hover:text-red-500 hover:border-red-200 flex items-center justify-center transition shadow-sm" title="Excluir Bloqueio"><i class="fas fa-times"></i></button></form>
                            </div>
                            {% else %}
                            <p class="text-center text-xs text-gray-400 py-4 opacity-50">Nenhuma data bloqueada.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="portfolio" class="tab-content hidden">
            <h2 class="text-2xl font-serif font-bold mb-6">Portfólio</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="bg-white p-8 rounded-2xl shadow-lg border border-gray-100 h-fit">
                    <h3 class="font-bold mb-6 text-lg">Adicionar Novo Caso</h3>
                    <form method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="acao" value="portfolio">
                        <div class="mb-6 relative group cursor-pointer">
                            <div class="border-2 border-dashed border-gray-300 rounded-xl p-10 text-center hover:bg-gray-50 hover:border-[#bf9b30] transition"><i class="fas fa-cloud-upload-alt text-4xl text-gray-300 group-hover:text-[#bf9b30] mb-2 transition"></i><p class="text-xs text-gray-400 font-bold uppercase">Carregar Foto</p></div>
                            <input type="file" name="foto" required class="absolute inset-0 opacity-0 cursor-pointer">
                        </div>
                        <div class="space-y-4">
                            <div><label class="block text-[10px] font-bold uppercase text-gray-400 mb-1">Título</label><input type="text" name="titulo" placeholder="Ex: Facetas" class="w-full border-b border-gray-200 py-2 focus:border-black outline-none font-medium"></div>
                            <div><label class="block text-[10px] font-bold uppercase text-gray-400 mb-1">Descrição</label><textarea name="descricao" placeholder="Detalhes..." class="w-full border-b border-gray-200 py-2 focus:border-black outline-none h-20 text-sm resize-none"></textarea></div>
                        </div>
                        <button class="w-full bg-black text-white py-3 rounded-lg font-bold text-xs uppercase mt-6 shadow hover:bg-[#bf9b30] transition">Publicar</button>
                    </form>
                </div>
                <div class="md:col-span-2">
                    <div class="grid grid-cols-2 gap-4">
                        {% for p in posts %}
                        <div class="relative group h-48 rounded-2xl overflow-hidden shadow-md cursor-pointer">
                            <img src="{{ p.imagem_arquivo }}" class="w-full h-full object-cover transform transition duration-700 group-hover:scale-110">
                            <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition duration-300 flex flex-col justify-center items-center text-white p-4 text-center">
                                <p class="font-bold text-sm mb-1">{{ p.titulo }}</p>
                                <span class="bg-[#bf9b30] text-[9px] px-2 py-1 rounded font-bold uppercase text-black">Publicado</span>
                            </div>
                        </div>
                        {% else %}
                        <div class="col-span-2 text-center py-20 bg-gray-50 rounded-2xl border-2 border-dashed border-gray-200"><p class="text-gray-400">Seu portfólio está vazio.</p></div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div id="perfil" class="tab-content hidden">
            <h2 class="text-2xl font-serif font-bold mb-6">Meu Perfil</h2>
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden relative border border-gray-100">
                <div class="h-32 bg-gray-900 relative">
                    <div class="absolute inset-0 bg-gradient-to-r from-black to-gray-800 opacity-90"></div>
                    <div class="absolute bottom-6 left-8 text-white"><p class="text-[10px] uppercase tracking-widest text-[#bf9b30] font-bold mb-1">Professional ID</p><h3 class="text-xl font-serif">Ficha Técnica</h3></div>
                </div>
                <div class="p-8 relative">
                    <div class="absolute -top-12 right-8 w-24 h-24 rounded-full border-4 border-white shadow-2xl overflow-hidden bg-white">
                        <img src="{{ current_user.foto_perfil }}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3774/3774299.png'" class="w-full h-full object-cover">
                    </div>
                    <form id="form-perfil" method="POST" enctype="multipart/form-data" class="mt-4 space-y-6">
                        <input type="hidden" name="acao" value="perfil">
                        <div><label class="block text-xs font-bold uppercase text-gray-400 mb-1">Minha Clínica de Atuação</label>
                            <select name="clinica_id" class="input-locked w-full border-b border-gray-200 py-2 text-lg text-gray-800 bg-white" disabled>
                                <option value="">Selecione sua base...</option>
                                {% for c in clinicas %}
                                <option value="{{ c.id }}" {{ 'selected' if current_user.clinica_id == c.id }}>{{ c.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div><label class="block text-xs font-bold uppercase text-gray-400 mb-1">E-mail de Acesso</label><input type="text" value="{{ current_user.email }}" disabled class="input-locked w-full border-b border-gray-200 py-2 text-lg text-gray-800 bg-gray-50 pl-2"></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div><label class="block text-xs font-bold uppercase text-gray-400 mb-1">Nome Profissional</label><input type="text" name="nome" value="{{ current_user.nome }}" disabled class="input-locked w-full border-b border-gray-200 py-2 text-lg text-gray-800"></div>
                            <div><label class="block text-xs font-bold uppercase text-gray-400 mb-1">WhatsApp</label><input type="text" name="telefone" value="{{ current_user.telefone or '' }}" disabled class="input-locked w-full border-b border-gray-200 py-2 text-lg text-gray-800"></div>
                        </div>
                        <div><label class="block text-xs font-bold uppercase text-gray-400 mb-1">Especialidade</label><input type="text" name="especialidade" value="{{ current_user.especialidade or '' }}" disabled class="input-locked w-full border-b border-gray-200 py-2 text-lg text-gray-800"></div>
                        <div id="campo-senha" class="hidden bg-gray-50 p-4 rounded-xl border border-gray-200"><label class="block text-xs font-bold uppercase text-gray-500 mb-2">Redefinir Senha</label><div class="relative"><input type="password" name="senha" id="senha_input" placeholder="Nova senha (opcional)" class="w-full bg-white border border-gray-300 rounded-lg p-3 pr-10 text-sm focus:border-[#bf9b30] outline-none"><i class="fas fa-eye absolute right-3 top-3.5 text-gray-400 cursor-pointer hover:text-black transition" onclick="toggleSenha()"></i></div></div>
                        <div class="group relative z-0 w-full mb-6"><label class="block text-xs font-bold uppercase text-gray-400 mb-1">Biografia</label><textarea name="bio" disabled class="input-locked w-full border-b border-gray-200 py-2 text-gray-600 h-24 resize-none">{{ current_user.bio or '' }}</textarea></div>
                        <div id="campo-foto" class="hidden"><label class="block text-xs font-bold uppercase text-gray-400 mb-2">Atualizar Foto</label><input type="file" name="foto_perfil" class="block w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200"></div>
                        <div class="flex gap-4 pt-6 border-t border-gray-50">
                            <button type="button" id="btn-editar" onclick="ativarEdicao()" class="px-6 py-2.5 border border-gray-300 rounded-lg text-xs font-bold text-gray-600 hover:bg-black hover:text-white hover:border-black transition uppercase tracking-wider"><i class="fas fa-pencil-alt mr-2"></i> Editar Dados</button>
                            <button type="submit" id="btn-salvar" class="hidden px-6 py-2.5 bg-black rounded-lg text-xs font-bold text-white hover:bg-[#bf9b30] transition shadow-lg uppercase tracking-wider">Salvar Alterações</button>
                            <button type="button" id="btn-cancelar" onclick="location.reload()" class="hidden px-6 py-2.5 border border-red-200 rounded-lg text-xs font-bold text-red-500 hover:bg-red-50 transition uppercase tracking-wider">Cancelar</button>
                        
                        
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </main>

    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-100 flex overflow-x-auto scrollbar-hide justify-between px-4 py-3 z-50 space-x-6">
        <button onclick="showTab('agenda')" class="mobile-link text-[#bf9b30] flex flex-col items-center shrink-0"><i class="fas fa-calendar-alt"></i></button>
        <button onclick="showTab('atendimento')" class="mobile-link text-gray-400 flex flex-col items-center shrink-0"><i class="fas fa-stethoscope"></i></button>
        <button onclick="showTab('historico')" class="mobile-link text-gray-400 flex flex-col items-center shrink-0"><i class="fas fa-history"></i></button>
        <button onclick="showTab('agendar')" class="mobile-link text-gray-400 flex flex-col items-center shrink-0"><i class="fas fa-plus-circle"></i></button>
        <button onclick="showTab('emergencia')" class="mobile-link text-gray-400 flex flex-col items-center shrink-0"><i class="fas fa-ban"></i></button>
        <button onclick="showTab('portfolio')" class="mobile-link text-gray-400 flex flex-col items-center shrink-0"><i class="fas fa-camera"></i></button>
        <button onclick="showTab('perfil')" class="mobile-link text-gray-400 flex flex-col items-center shrink-0"><i class="fas fa-user"></i></button>
    </nav>

    <script>
        const activeTab = "{{ active_tab }}";
        
        // CORREÇÃO DATA LOCAL (FUSO BRASÍLIA)
        const nowBrasilia = new Date(new Date().toLocaleString("en-US", {timeZone: "America/Sao_Paulo"}));
        
        const year = nowBrasilia.getFullYear();
        const month = String(nowBrasilia.getMonth() + 1).padStart(2, '0');
        const day = String(nowBrasilia.getDate()).padStart(2, '0');
        const todayISO = `${year}-${month}-${day}`; 

        // Arrays de bloqueio vindos do Python
        const diasSemanaFolga = [
            {% if current_user.dia_folga_semanal %}
                {{ current_user.dia_folga_semanal }}
            {% endif %}
        ];

        const datasBloqueadas = [
            {% for f in folgas %}
                "{{ f.data.strftime('%Y-%m-%d') }}",
            {% endfor %}
        ];

        // Formata data em PT-BR para o cabeçalho
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        let dataFormatada = nowBrasilia.toLocaleDateString('pt-BR', options);
        document.getElementById('data-atual-display').innerText = dataFormatada.charAt(0).toUpperCase() + dataFormatada.slice(1);

        document.addEventListener("DOMContentLoaded", function() {
            // Define data mínima como HOJE DE BRASÍLIA para todos os inputs de data
            const inputsData = ['data_retorno_sala', 'data_dia_agendamento', 'data_bloqueio_input'];
            inputsData.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.min = todayISO;
            });
            
            organizarAgenda();
            atualizarFiltroMeses();
            
            // Ativa validação inicial para limpar horários
            atualizarHorarios('data_retorno_sala', 'hora_retorno_sala');
            atualizarHorarios('data_dia_agendamento', 'data_hora_agendamento');
        });

        // NOVA FUNÇÃO UNIFICADA DE HORÁRIOS (VALIDA AGENDAMENTO E RETORNO)
        function atualizarHorarios(dateInputId, timeSelectId) {
            const dateInput = document.getElementById(dateInputId);
            const timeSelect = document.getElementById(timeSelectId);
            if(!dateInput || !timeSelect) return;

            const selectedDate = dateInput.value;
            
            // RESET ESTILOS
            dateInput.classList.remove('blocked-input');
            timeSelect.classList.remove('blocked-input');
            timeSelect.disabled = false;
            
            if(!selectedDate) return;
            
            // 1. VERIFICAÇÃO DE BLOQUEIO (DATA ESPECÍFICA)
            if (datasBloqueadas.includes(selectedDate)) {
                // APLICA O ESTILO "CINZA" E BLOQUEIA
                dateInput.classList.add('blocked-input');
                timeSelect.classList.add('blocked-input');
                timeSelect.disabled = true;
                timeSelect.innerHTML = '<option>Dia Bloqueado</option>';
                return;
            }

            // 2. VERIFICAÇÃO DE FOLGA SEMANAL
            // Usamos T00:00:00 para evitar problemas de fuso na conversão
            const dateObj = new Date(selectedDate + "T00:00:00");
            let dayOfWeek = dateObj.getDay(); 
            // JS: 0=Dom, 6=Sab. Python: 0=Seg, 6=Dom.
            let pyDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

            if (diasSemanaFolga.includes(pyDay)) {
                // APLICA O ESTILO "CINZA" E BLOQUEIA
                dateInput.classList.add('blocked-input');
                timeSelect.classList.add('blocked-input');
                timeSelect.disabled = true;
                timeSelect.innerHTML = '<option>Folga Fixa</option>';
                return;
            }

            // 3. Lógica de Horários (Passado / 18h)
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "America/Sao_Paulo"}));
            const currentHour = now.getHours();
            
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.getFullYear() + '-' + 
                                String(tomorrow.getMonth() + 1).padStart(2, '0') + '-' + 
                                String(tomorrow.getDate()).padStart(2, '0');

            // Recria opções originais (se não foi bloqueado acima)
            timeSelect.innerHTML = `
                <option value="08:00">08:00</option><option value="09:00">09:00</option>
                <option value="10:00">10:00</option><option value="11:00">11:00</option>
                <option value="13:00">13:00</option><option value="14:00">14:00</option>
                <option value="15:00">15:00</option><option value="16:00">16:00</option>
                <option value="17:00">17:00</option>
            `;

            // Regra do Passado (Se for HOJE)
            if(selectedDate === todayISO) {
                 for(let i=0; i < timeSelect.options.length; i++) {
                    const val = parseInt(timeSelect.options[i].value.split(':')[0]); 
                    if (val <= currentHour) {
                        timeSelect.options[i].disabled = true;
                        timeSelect.options[i].style.color = "#ccc";
                        timeSelect.options[i].innerText += " (Passado)";
                    }
                }
            }

            // Regra das 18h (Se for AMANHÃ)
            if(selectedDate === tomorrowStr && currentHour >= 18) {
                for(let i=0; i < timeSelect.options.length; i++) {
                    const val = timeSelect.options[i].value;
                    if(val === "08:00" || val === "09:00") {
                        timeSelect.options[i].disabled = true;
                        timeSelect.options[i].style.color = "#ccc";
                        timeSelect.options[i].innerText += " (Fechado)";
                    }
                }
            }
        }
        
        function atualizarFiltroMeses() {
            const anoSelect = document.getElementById('filtro_ano');
            const mesSelect = document.getElementById('filtro_mes');
            
            const anoAtual = new Date().getFullYear();
            const mesAtual = new Date().getMonth() + 1; 
            
            const anoSelecionado = parseInt(anoSelect.value) || anoAtual;
            const options = mesSelect.options;

            for (let i = 1; i < options.length; i++) {
                options[i].style.display = 'block'; 
                if (anoSelecionado > anoAtual) {
                     options[i].style.display = 'none';
                }
                else if (anoSelecionado === anoAtual) {
                     if (parseInt(options[i].value) > mesAtual) {
                        options[i].style.display = 'none';
                    }
                }
            }
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            
            document.querySelectorAll('.desktop-link').forEach(l => {
                l.classList.remove('text-black', 'bg-gray-50');
                if(l.getAttribute('onclick').includes(tabId)) l.classList.add('text-black', 'bg-gray-50');
            });
            
            document.querySelectorAll('.mobile-link').forEach(l => {
                l.classList.remove('text-[#bf9b30]');
                l.classList.add('text-gray-400');
                if(l.getAttribute('onclick').includes(tabId)) {
                   l.classList.remove('text-gray-400');
                   l.classList.add('text-[#bf9b30]');
                }
            });
        }
        showTab(activeTab || 'agenda');

        const todosDentistas = [];
        {% if todos_dentistas %}
            {% for d in todos_dentistas %}
            todosDentistas.push({ id: "{{ d.id }}", nome: "{{ d.nome }}", clinica_id: "{{ d.clinica_id or 1 }}", folga: "{{ d.dia_folga_semanal if d.dia_folga_semanal is not none else '' }}" });
            {% endfor %}
        {% endif %}
        
        const agendamentosOcupados = [];
        {% if agendamentos_ocupados %}
            {% for a in agendamentos_ocupados %}
            agendamentosOcupados.push({
                dentista_id: "{{ a.dentista_id }}",
                data: "{{ a.data }}",
                hora: "{{ a.hora }}"
            });
            {% endfor %}
        {% endif %}

        function filtrarMedicosAgendamento() {
            const clinicaId = document.getElementById('clinica_agendamento').value;
            const selectDentista = document.getElementById('dentista_agendamento');
            selectDentista.innerHTML = '<option value="">Selecione o Médico...</option>';
            todosDentistas.forEach(d => {
                if (d.clinica_id == clinicaId) {
                    const opt = document.createElement('option');
                    opt.value = d.id;
                    opt.innerText = d.nome;
                    selectDentista.appendChild(opt);
                }
            });
        }
        
        function verificarDisponibilidade() {
            const dentistaId = document.getElementById('dentista_agendamento').value;
            const dataInput = document.getElementById('data_dia_agendamento');
            const dataVal = dataInput.value; 
            const selectHora = document.getElementById('data_hora_agendamento');
            const options = selectHora.options;
            
            // Chama a validação de hora (Passado/18h e Bloqueios)
            atualizarHorarios('data_dia_agendamento', 'data_hora_agendamento');

            if (!dentistaId || !dataVal) return;
            
            // Bloqueia horários ocupados do banco
            for (let i = 0; i < options.length; i++) {
                let horaOptStr = options[i].value;
                const ocupado = agendamentosOcupados.some(a => 
                    a.dentista_id === dentistaId && a.data === dataVal && a.hora === horaOptStr
                );

                if (ocupado) {
                    options[i].disabled = true;
                    options[i].innerText = horaOptStr + " (Ocupado)";
                    options[i].style.color = "#ccc";
                }
            }
        }
        
        document.querySelectorAll('textarea').forEach(el => {
            el.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        });

        function organizarAgenda() {
            const containerDados = document.getElementById('dados-futuros');
            const listaAmanha = document.getElementById('lista-amanha');
            const listaFuturo = document.getElementById('lista-futuro');
            
            if(!containerDados) return;

            // Calcula AMANHÃ (Fuso Brasilia)
            const amanha = new Date(nowBrasilia); 
            amanha.setDate(amanha.getDate() + 1);
            
            const year = amanha.getFullYear();
            const month = String(amanha.getMonth() + 1).padStart(2, '0');
            const day = String(amanha.getDate()).padStart(2, '0');
            const strAmanha = `${year}-${month}-${day}`;
            
            let countAmanha = 0; 
            let countFuturo = 0;
            
            containerDados.querySelectorAll('.agenda-item').forEach(item => {
                const dataItem = item.getAttribute('data-date');
                if (dataItem === strAmanha) { 
                    listaAmanha.appendChild(item); 
                    countAmanha++; 
                } else { 
                    listaFuturo.appendChild(item); 
                    countFuturo++; 
                }
            });
            
            if(countAmanha > 0) {
                 const msg = listaAmanha.querySelector('.empty-msg');
                 if(msg) msg.style.display = 'none';
            }
            if(countFuturo > 0) {
                 const msg = listaFuturo.querySelector('.empty-msg');
                 if(msg) msg.style.display = 'none';
            }
            
            document.getElementById('count-amanha').innerText = countAmanha;
            document.getElementById('count-futuro').innerText = countFuturo;
        }

        function ativarEdicao() {
            document.querySelectorAll('.input-locked').forEach(el => {
                el.disabled = false; el.classList.remove('input-locked'); el.classList.add('input-editable');
            });
            document.getElementById('campo-senha').classList.remove('hidden');
            document.getElementById('campo-foto').classList.remove('hidden');
            document.getElementById('btn-editar').classList.add('hidden');
            document.getElementById('btn-salvar').classList.remove('hidden');
            document.getElementById('btn-cancelar').classList.remove('hidden');
        }

        function toggleSenha() {
            const input = document.getElementById('senha_input');
            const icon = document.querySelector('.fa-eye');
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove('text-gray-400');
                icon.classList.add('text-black');
            } else {
                input.type = "password";
                icon.classList.add('text-gray-400');
                icon.classList.remove('text-black');
            }
        }

        setTimeout(() => { document.querySelectorAll('.fade-out').forEach(el => el.style.display = 'none'); }, 4000);
    </script>
</body>
</html>