<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Exclusive | L'Odontologie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'luxury-gold': '#bf9b30',
                        'luxury-black': '#0a0a0a',
                        'luxury-gray': '#f8f8f8',
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Inter"', 'sans-serif']
                    }
                }
            }
        }

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabName).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-luxury-gold', 'text-white', 'shadow-lg');
                btn.classList.add('text-gray-400', 'hover:bg-gray-50');
            });
            const btn = document.getElementById('btn-' + tabName);
            if(btn) {
                btn.classList.add('bg-luxury-gold', 'text-white', 'shadow-lg');
                btn.classList.remove('text-gray-400', 'hover:bg-gray-50');
            }
        }

        function toggleMenu() {
            document.getElementById('mobile-menu').classList.toggle('-translate-x-full');
        }
        
        let currentHistorico = [];
        function verFichaTecnica(pacienteNome, historicoJson) {
            const modal = document.getElementById('modal-prontuario');
            const lista = document.getElementById('lista-prontuarios');
            document.getElementById('modal-paciente').innerText = pacienteNome;
            
            const dataInput = document.getElementById('filtro_data_modal');
            dataInput.value = '';
            const today = new Date().toISOString().split('T')[0];
            dataInput.setAttribute('max', today);
            
            try {
                currentHistorico = (typeof historicoJson === 'string') ? JSON.parse(historicoJson) : historicoJson;
                renderizarProntuario(currentHistorico);
            } catch(e) { 
                document.getElementById('lista-prontuarios').innerHTML = '<p class="text-red-500 text-sm text-center">Erro ao carregar dados.</p>'; 
            }
            modal.classList.remove('hidden');
        }

        function renderizarProntuario(dados) {
            const lista = document.getElementById('lista-prontuarios');
            lista.innerHTML = '';
            if(dados && dados.length > 0) {
                dados.forEach(h => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-6 rounded-xl border-l-4 border-l-luxury-gold shadow-sm mb-6 relative border border-gray-100';
                    item.innerHTML = `
                        <div class="flex justify-between items-start mb-4 border-b border-gray-100 pb-2">
                            <div><p class="text-lg font-bold text-luxury-black">${h.servico}</p><p class="text-xs text-gray-500">Dr(a). ${h.medico}</p></div>
                            <div class="text-right"><span class="bg-luxury-gold/10 text-luxury-gold text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">${h.data_hora}</span></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-4">
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-[9px] font-bold uppercase text-gray-400 mb-1">Queixa Principal</p><p class="text-gray-700 leading-snug">${h.queixa || '-'}</p></div>
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-[9px] font-bold uppercase text-gray-400 mb-1">Procedimento Realizado</p><p class="text-gray-700 leading-snug">${h.procedimento || '-'}</p></div>
                        </div>
                        <div class="space-y-3">
                            <div><p class="text-[9px] font-bold uppercase text-gray-400 mb-1">Evolução Clínica</p><p class="text-sm text-gray-600 italic border-l-2 border-gray-200 pl-3">${h.evolucao || 'Sem anotações.'}</p></div>
                            ${h.proximos_passos && h.proximos_passos !== '-' ? `<div class="bg-blue-50 p-3 rounded-lg border border-blue-100 mt-2"><p class="text-[9px] font-bold uppercase text-blue-400 mb-1">Próximos Passos / Observações</p><p class="text-xs text-blue-800 font-bold">${h.proximos_passos}</p></div>` : ''}
                        </div>
                    `;
                    lista.appendChild(item);
                });
            } else {
                lista.innerHTML = '<div class="text-center py-12 opacity-50"><i class="fas fa-file-medical-alt text-4xl text-gray-300 mb-3"></i><p class="text-gray-400 text-sm font-bold">Nenhum registro encontrado.</p></div>';
            }
        }

        function filtrarProntuarioPorData() {
            const inputDate = document.getElementById('filtro_data_modal').value;
            if (!inputDate) { renderizarProntuario(currentHistorico); return; }
            const parts = inputDate.split('-');
            const dataFormatada = `${parts[2]}/${parts[1]}/${parts[0]}`;
            const filtrados = currentHistorico.filter(h => h.data_hora.startsWith(dataFormatada));
            renderizarProntuario(filtrados);
        }

        function fecharModal() {
            document.getElementById('modal-prontuario').classList.add('hidden');
        }

        function abrirModalCancelar(event, idAgendamento) {
            event.stopPropagation(); 
            document.getElementById('id_cancelamento').value = idAgendamento;
            document.getElementById('modal-confirm-cancel').classList.remove('hidden');
        }

        function fecharModalCancelar() {
            document.getElementById('modal-confirm-cancel').classList.add('hidden');
        }

        function abrirModalExclusao(acao, id) {
            document.getElementById('acao_exclusao').value = acao;
            document.getElementById('id_user_exclusao').value = '';
            document.getElementById('id_clinica_exclusao').value = '';
            
            if(acao === 'excluir_user') {
                document.getElementById('id_user_exclusao').value = id;
                document.getElementById('msg_exclusao').innerText = "Tem certeza que deseja demitir este especialista? O acesso será revogado.";
            } else {
                document.getElementById('id_clinica_exclusao').value = id;
                document.getElementById('msg_exclusao').innerText = "Tem certeza que deseja excluir esta unidade? O histórico pode ser afetado.";
            }
            document.getElementById('modal-confirm-delete').classList.remove('hidden');
        }

        function fecharModalExclusao() {
            document.getElementById('modal-confirm-delete').classList.add('hidden');
        }
        
        function fecharModalWpp() {
            document.getElementById('modal-whatsapp').classList.add('hidden');
        }
    </script>
    <style>
        .input-gold { background: #fff; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 0.75rem; width: 100%; transition: all 0.3s; font-size: 0.875rem; }
        .input-gold:focus { border-color: #bf9b30; outline: none; box-shadow: 0 0 0 3px rgba(191, 155, 48, 0.1); }
        .nav-btn { transition: all 0.3s ease; }
        body { background-color: #f8f8f8; padding-bottom: 80px; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 4px; }
        .tab-content.hidden { display: none !important; }
        
        /* Estilo Bloqueio */
        .blocked-input { background-color: #e5e7eb !important; color: #9ca3af !important; cursor: not-allowed; border-color: #d1d5db; }
    </style>
</head>

<body class="font-sans text-gray-800 antialiased flex flex-col md:flex-row min-h-screen">

    <aside class="hidden md:flex w-72 bg-white border-r border-gray-100 flex-col justify-between shrink-0 fixed h-full z-20 shadow-xl">
        <div>
            <div class="h-28 flex flex-col justify-center items-center border-b border-gray-50">
                <h1 class="font-serif font-bold text-xl tracking-widest text-luxury-black">L'ODONTOLOGIE</h1>
                <span class="text-[9px] text-luxury-gold font-bold uppercase tracking-[0.3em] mt-1">Administrator</span>
            </div>
            <nav class="mt-8 px-4 space-y-2">
                <button id="btn-dashboard" onclick="openTab('dashboard')" class="nav-btn w-full py-4 px-6 text-left text-xs font-bold uppercase tracking-widest rounded-xl flex items-center gap-3 {{ 'bg-luxury-gold text-white shadow-lg' if active_tab == 'dashboard' else 'text-gray-400 hover:bg-gray-50' }}"><i class="fas fa-chart-pie w-5"></i> Dashboard</button>
                <button id="btn-agenda" onclick="openTab('agenda')" class="nav-btn w-full py-4 px-6 text-left text-xs font-bold uppercase tracking-widest rounded-xl flex items-center gap-3 {{ 'bg-luxury-gold text-white shadow-lg' if active_tab == 'agenda' else 'text-gray-400 hover:bg-gray-50' }}"><i class="far fa-calendar-alt w-5"></i> Agenda Global</button>
                <button id="btn-historico" onclick="openTab('historico')" class="nav-btn w-full py-4 px-6 text-left text-xs font-bold uppercase tracking-widest rounded-xl flex items-center gap-3 {{ 'bg-luxury-gold text-white shadow-lg' if active_tab == 'historico' else 'text-gray-400 hover:bg-gray-50' }}"><i class="fas fa-file-medical-alt w-5"></i> Histórico Geral</button>
                <button id="btn-equipe" onclick="openTab('equipe')" class="nav-btn w-full py-4 px-6 text-left text-xs font-bold uppercase tracking-widest rounded-xl flex items-center gap-3 {{ 'bg-luxury-gold text-white shadow-lg' if active_tab == 'equipe' else 'text-gray-400 hover:bg-gray-50' }}"><i class="fas fa-user-md w-5"></i> Especialistas</button>
                <button id="btn-clinicas" onclick="openTab('clinicas')" class="nav-btn w-full py-4 px-6 text-left text-xs font-bold uppercase tracking-widest rounded-xl flex items-center gap-3 {{ 'bg-luxury-gold text-white shadow-lg' if active_tab == 'clinicas' else 'text-gray-400 hover:bg-gray-50' }}"><i class="fas fa-map-marker-alt w-5"></i> Unidades</button>
                <button id="btn-site" onclick="openTab('site')" class="nav-btn w-full py-4 px-6 text-left text-xs font-bold uppercase tracking-widest rounded-xl flex items-center gap-3 {{ 'bg-luxury-gold text-white shadow-lg' if active_tab == 'site' else 'text-gray-400 hover:bg-gray-50' }}"><i class="fas fa-laptop-code w-5"></i> Editor Site</button>
            </nav>
        </div>
        <div class="p-8 border-t border-gray-50">
            <a href="/logout" class="flex items-center justify-center gap-2 text-red-400 hover:text-red-600 transition text-xs font-bold uppercase tracking-widest bg-red-50 py-3 rounded-lg hover:bg-red-100"><i class="fas fa-power-off"></i> Sair</a>
        </div>
    </aside>

    <div class="md:hidden bg-white/95 backdrop-blur-md p-4 shadow-sm flex justify-between items-center sticky top-0 z-40 border-b border-gray-100">
        <div><p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Painel Admin</p><p class="text-sm font-bold leading-none font-serif text-luxury-gold">L'ODONTOLOGIE</p></div>
        <a href="/logout" class="text-gray-400 hover:text-red-500"><i class="fas fa-sign-out-alt"></i></a>
    </div>

    <main class="flex-1 md:ml-72 p-4 md:p-10 w-full max-w-7xl mx-auto">

        {% if sucesso %}<div class="mb-6 bg-green-50 text-green-800 px-6 py-4 rounded-xl shadow-sm border border-green-100 flex items-center gap-3 animate-fade-in-up"><i class="fas fa-check-circle"></i> {{ sucesso }}</div>{% endif %}
        {% if erro %}<div class="mb-6 bg-red-50 text-red-800 px-6 py-4 rounded-xl shadow-sm border border-red-100 flex items-center gap-3 animate-fade-in-up"><i class="fas fa-exclamation-circle"></i> {{ erro }}</div>{% endif %}

        <div id="dashboard" class="tab-content {{ 'hidden' if active_tab != 'dashboard' else '' }}">
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div><h2 class="text-3xl font-serif font-bold text-luxury-black mb-2">Visão Geral</h2><p class="text-gray-400 text-sm">Performance da Rede.</p></div>
                <form method="GET" class="flex gap-2 w-full md:w-auto"><input type="hidden" name="tab" value="dashboard"><select name="filtro_unidade_dash" class="text-xs bg-white border border-gray-200 rounded-lg p-3 font-bold w-full md:w-auto" onchange="this.form.submit()"><option value="">Todas as Unidades (Total)</option>{% for c in clinicas %}<option value="{{ c.id }}" {{ 'selected' if request.args.get('filtro_unidade_dash') == c.id|string }}>{{ c.nome }}</option>{% endfor %}</select></form>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-10">
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 flex items-center gap-4"><div class="w-12 h-12 rounded-full bg-luxury-gold text-white flex items-center justify-center text-xl shadow-lg shadow-luxury-gold/30"><i class="fas fa-calendar-check"></i></div><div><p class="text-[10px] uppercase tracking-widest text-gray-400 font-bold">Hoje</p><h3 class="text-2xl font-bold text-luxury-black">{{ stats.hoje }}</h3></div></div>
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 flex items-center gap-4"><div class="w-12 h-12 rounded-full bg-green-500 text-white flex items-center justify-center text-xl shadow-lg shadow-green-500/30"><i class="fas fa-check-double"></i></div><div><p class="text-[10px] uppercase tracking-widest text-gray-400 font-bold">Realizadas</p><h3 class="text-2xl font-bold text-luxury-black">{{ stats.total_concluidas }}</h3></div></div>
                
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 flex items-center gap-4"><div class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center text-xl shadow-lg shadow-blue-500/30"><i class="fas fa-user-md"></i></div><div><p class="text-[10px] uppercase tracking-widest text-gray-400 font-bold">Equipe Ativa</p><h3 class="text-2xl font-bold text-luxury-black">{{ stats.equipe_ativa }}</h3></div></div>
                
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 flex items-center gap-4"><div class="w-12 h-12 rounded-full bg-red-500 text-white flex items-center justify-center text-xl shadow-lg shadow-red-500/30"><i class="fas fa-ban"></i></div><div><p class="text-[10px] uppercase tracking-widest text-gray-400 font-bold">Canceladas</p><h3 class="text-2xl font-bold text-luxury-black">{{ stats.total_canceladas }}</h3></div></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-8 rounded-[2rem] shadow-sm border border-gray-100"><h3 class="text-sm font-bold uppercase tracking-widest text-green-600 mb-6 flex items-center gap-2"><i class="fas fa-chart-line"></i> Consultas Realizadas</h3><div class="space-y-6"><div class="flex justify-between items-center border-b border-gray-50 pb-3"><span class="text-xs text-gray-500 font-bold uppercase">Esta Semana</span><span class="text-xl font-bold text-luxury-black">{{ stats.semana_concluidas }}</span></div><div class="flex justify-between items-center border-b border-gray-50 pb-3"><span class="text-xs text-gray-500 font-bold uppercase">Este Mês</span><span class="text-xl font-bold text-luxury-black">{{ stats.mes_concluidas }}</span></div><div class="flex justify-between items-center"><span class="text-xs text-gray-500 font-bold uppercase">Este Ano</span><span class="text-xl font-bold text-luxury-black">{{ stats.ano_concluidas }}</span></div></div></div>
                <div class="bg-white p-8 rounded-[2rem] shadow-sm border border-gray-100"><h3 class="text-sm font-bold uppercase tracking-widest text-red-500 mb-6 flex items-center gap-2"><i class="fas fa-chart-bar"></i> Taxa de Cancelamento</h3><div class="space-y-6"><div class="flex justify-between items-center border-b border-gray-50 pb-3"><span class="text-xs text-gray-500 font-bold uppercase">Esta Semana</span><span class="text-xl font-bold text-gray-800">{{ stats.semana_canceladas }}</span></div><div class="flex justify-between items-center border-b border-gray-50 pb-3"><span class="text-xs text-gray-500 font-bold uppercase">Este Mês</span><span class="text-xl font-bold text-luxury-black">{{ stats.mes_canceladas }}</span></div><div class="flex justify-between items-center"><span class="text-xs text-gray-500 font-bold uppercase">Este Ano</span><span class="text-xl font-bold text-luxury-black">{{ stats.ano_canceladas }}</span></div></div></div>
            </div>
        </div>

        <div id="historico" class="tab-content {{ 'hidden' if active_tab != 'historico' else '' }}">
            <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4"><div><h2 class="text-3xl font-serif font-bold text-luxury-black">Histórico Geral</h2><p class="text-gray-400 text-sm mt-1">Busque prontuários completos.</p></div></div>
            <form method="GET" class="bg-white p-6 rounded-[2rem] shadow-lg border border-gray-100 mb-8"><input type="hidden" name="tab" value="historico">
                <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-5 gap-4 items-end">
                    <div class="md:col-span-1"><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Paciente (Nome/ID/Email)</label><input type="text" name="busca_paciente" class="input-gold" placeholder="Digite..." value="{{ request.args.get('busca_paciente', '') }}"></div>
                    <div class="md:col-span-1"><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Data Específica</label><input type="date" name="filtro_data" class="input-gold" value="{{ request.args.get('filtro_data', '') }}"></div>
                    <div class="md:col-span-1"><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Mês</label><input type="month" name="filtro_mes" class="input-gold" value="{{ request.args.get('filtro_mes', '') }}"></div>
                    <div class="md:col-span-1"><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Ano</label><input type="number" name="filtro_ano" class="input-gold" placeholder="2025" value="{{ request.args.get('filtro_ano', '') }}"></div>
                    <div class="md:col-span-1"><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Status</label><select name="filtro_status" class="input-gold"><option value="">Todos</option><option value="agendados" {{ 'selected' if request.args.get('filtro_status') == 'agendados' }}>Agendados</option><option value="concluidos" {{ 'selected' if request.args.get('filtro_status') == 'concluidos' }}>Concluídos</option><option value="cancelados" {{ 'selected' if request.args.get('filtro_status') == 'cancelados' }}>Cancelados</option></select></div>
                    <div class="md:col-span-2 lg:col-span-2"><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Unidade</label><select name="filtro_clinica" class="input-gold"><option value="">Todas</option>{% for c in clinicas %}<option value="{{ c.id }}" {{ 'selected' if request.args.get('filtro_clinica') == c.id|string }}>{{ c.nome }}</option>{% endfor %}</select></div>
                    <div class="md:col-span-2 lg:col-span-2"><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Especialista</label><select name="filtro_medico" class="input-gold"><option value="">Todos</option>{% for d in dentistas %}<option value="{{ d.id }}" {{ 'selected' if request.args.get('filtro_medico') == d.id|string }}>{{ d.nome }}</option>{% endfor %}</select></div>
                    <div class="md:col-span-5 lg:col-span-1 flex gap-2"><button class="bg-luxury-black text-white w-full h-[46px] rounded-xl font-bold uppercase text-xs hover:bg-luxury-gold transition shadow-lg">Filtrar</button><a href="/painel/admin?tab=historico" class="bg-gray-200 text-gray-600 w-full h-[46px] rounded-xl font-bold uppercase text-xs hover:bg-gray-300 transition flex items-center justify-center">Limpar</a></div>
                </div>
            </form>
            <div class="space-y-4">
                {% for item in historico_global %}
                <div class="md:hidden bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start mb-4">
                        <div><p class="font-bold text-gray-900">{{ item.paciente.nome }}</p><p class="text-xs text-gray-500">Dr(a). {{ item.dentista.nome }}</p></div>
                        <span class="px-2 py-1 rounded text-[10px] font-bold uppercase {{ 'bg-green-100 text-green-700' if 'Concluído' in item.status else ('bg-red-100 text-red-600' if 'Cancelado' in item.status else 'bg-gray-100 text-gray-500') }}">{{ item.status }}</span>
                    </div>
                    <div class="flex justify-between items-center border-t border-gray-50 pt-4">
                        <span class="text-xs font-mono font-bold text-luxury-gold">{{ item.data_hora.strftime('%d/%m/%Y %H:%M') }}</span>
                        {% if 'Concluído' in item.status %}<button onclick="verFichaTecnica('{{ item.paciente.nome }}', '{{ item.paciente.get_historico_json() }}')" class="text-xs font-bold text-luxury-black underline">Ficha</button>{% endif %}
                    </div>
                </div>
                <div class="hidden md:block bg-white rounded-[2rem] shadow-sm border border-gray-100 overflow-hidden mb-2">
                    <table class="w-full text-left"><tr class="border-b border-gray-50 hover:bg-gray-50/50 transition"><td class="p-6 font-mono font-bold text-luxury-gold w-32">{{ item.data_hora.strftime('%d/%m/%Y') }}</td><td class="p-6 w-40"><span class="bg-gray-100 px-2 py-1 rounded text-[10px] font-bold uppercase">{{ item.dentista.clinica.nome if item.dentista.clinica else 'Matriz' }}</span></td><td class="p-6 font-bold text-gray-800">{{ item.paciente.nome }}</td><td class="p-6 text-sm">{{ item.dentista.nome }}</td><td class="p-6 w-32"><span class="px-2 py-1 rounded text-[10px] font-bold uppercase {{ 'bg-green-100 text-green-700' if 'Concluído' in item.status else ('bg-red-100 text-red-600' if 'Cancelado' in item.status else 'bg-gray-100 text-gray-500') }}">{{ item.status }}</span></td><td class="p-6 text-right w-32">{% if 'Concluído' in item.status %}<button onclick="verFichaTecnica('{{ item.paciente.nome }}', '{{ item.paciente.get_historico_json() }}')" class="text-xs font-bold text-luxury-black hover:text-luxury-gold border border-gray-200 px-4 py-2 rounded-lg hover:border-luxury-gold transition bg-white">Ver Prontuário</button>{% endif %}</td></tr></table>
                </div>
                {% else %}<p class="text-center text-gray-400 py-10">Nenhum histórico encontrado.</p>{% endfor %}
            </div>
        </div>

        <div id="agenda" class="tab-content {{ 'hidden' if active_tab != 'agenda' else '' }}">
            <h2 class="text-3xl font-serif font-bold text-luxury-black mb-6">Agenda Global</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 bg-white p-8 rounded-[2rem] shadow-lg border border-luxury-gold/20 h-fit">
                    <h3 class="text-sm font-bold uppercase tracking-widest text-luxury-gold mb-6 flex items-center gap-2"><i class="fas fa-calendar-plus"></i> Novo Agendamento</h3>
                    <form method="POST" class="space-y-4">
                        <input type="hidden" name="acao" value="admin_agendar"><input type="hidden" name="tab" value="agenda">
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Unidade</label><select id="clinica_agenda" name="clinica_id" class="input-gold" onchange="filtrarMedicosAgenda()" required><option value="">Selecione...</option>{% for c in clinicas %}<option value="{{ c.id }}">{{ c.nome }}</option>{% endfor %}</select></div>
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Dentista</label><select id="dentista_agenda" name="dentista_id" class="input-gold" onchange="atualizarHorariosAgenda()" required disabled><option value="">Selecione Unidade...</option></select></div>
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Paciente (Email/Nome)</label><input type="text" name="termo_busca" required class="input-gold" placeholder="Buscar..."></div>
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Motivo</label><input type="text" name="servico" required class="input-gold" placeholder="Ex: Avaliação"></div>
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Data</label><input type="date" name="data" id="data_agenda" onchange="atualizarHorariosAgenda()" required class="input-gold"></div>
                            <div><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Hora</label><select name="hora" id="hora_agenda" required class="input-gold"><option value="08:00">08:00</option><option value="09:00">09:00</option><option value="10:00">10:00</option><option value="11:00">11:00</option><option value="13:00">13:00</option><option value="14:00">14:00</option><option value="15:00">15:00</option><option value="16:00">16:00</option><option value="17:00">17:00</option></select></div>
                        </div>
                        <button class="bg-luxury-black text-white w-full py-4 rounded-xl font-bold uppercase text-xs hover:bg-luxury-gold transition shadow-lg mt-4">Confirmar Agendamento</button>
                    </form>
                </div>
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white p-8 rounded-[2rem] shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-gray-800">Agendamentos Futuros</h3>
                            <form method="GET" class="flex gap-2"><input type="hidden" name="tab" value="agenda"><select name="filtro_agenda_clinica" class="text-xs bg-gray-50 border-none rounded-lg p-2" onchange="this.form.submit()"><option value="">Todas Unidades</option>{% for c in clinicas %}<option value="{{ c.id }}" {{ 'selected' if request.args.get('filtro_agenda_clinica') == c.id|string }}>{{ c.nome }}</option>{% endfor %}</select></form>
                        </div>
                        <div class="space-y-4">
                            {% for c in consultas[:10] %}
                            {% if 'Cancelado' not in c.status %}
                            <div onclick="verFichaTecnica('{{ c.paciente.nome }}', '{{ c.paciente.get_historico_json() }}')" class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-100 hover:bg-white hover:shadow-md transition cursor-pointer group relative">
                                <div class="flex items-center gap-4">
                                    <div class="text-center"><p class="text-lg font-bold text-luxury-black">{{ c.data_hora.strftime('%H:%M') }}</p><p class="text-[9px] uppercase font-bold text-luxury-gold">{{ c.data_hora.strftime('%d/%m') }}</p></div>
                                    <div><p class="font-bold text-sm">{{ c.paciente.nome }}</p><p class="text-xs text-gray-500">Dr(a). {{ c.dentista.nome }}</p></div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-[9px] font-bold uppercase px-2 py-1 rounded {{ 'bg-green-100 text-green-700' if 'Confirmado' in c.status else 'bg-yellow-100 text-yellow-700' }}">{{ c.status }}</span>
                                    <button onclick="abrirModalCancelar(event, '{{ c.id }}')" type="button" class="w-8 h-8 rounded-full bg-white text-gray-300 hover:text-red-500 hover:bg-red-50 flex items-center justify-center transition border border-gray-200 z-10 relative"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                            {% endif %}
                            {% else %}<p class="text-center text-gray-400 text-sm py-10">Nenhum agendamento futuro encontrado.</p>{% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="equipe" class="tab-content {{ 'hidden' if active_tab != 'equipe' else '' }}"><h2 class="text-3xl font-serif font-bold text-luxury-black mb-6">Corpo Clínico</h2><div class="bg-white p-6 md:p-8 rounded-[2rem] shadow-sm border border-gray-100 mb-8"><h3 class="text-sm font-bold uppercase tracking-widest text-gold-primary mb-4">Novo Especialista</h3><form method="POST" class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="hidden" name="acao" value="cadastrar_dentista"><input type="text" name="nome" placeholder="Nome Completo" required class="input-gold"><input type="email" name="email" placeholder="E-mail Profissional" required class="input-gold"><input type="text" name="especialidade" placeholder="Especialidade" required class="input-gold"><input type="text" name="telefone" placeholder="Telefone" class="input-gold"><select name="clinica_id" class="input-gold" required><option value="">Selecione Unidade...</option>{% for c in clinicas %}<option value="{{ c.id }}">{{ c.nome }}</option>{% endfor %}</select><input type="password" name="senha" placeholder="Senha Provisória" value="123456" required class="input-gold"><button class="md:col-span-2 bg-luxury-black text-white py-3 rounded-lg font-bold uppercase text-xs hover:bg-luxury-gold transition mt-2">Contratar Especialista</button></form></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6">{% for d in dentistas %}<div class="bg-white p-6 rounded-[2rem] border border-gray-100 flex items-center justify-between"><div class="flex items-center gap-4"><img src="{{ d.foto_perfil if d.foto_perfil else 'https://cdn-icons-png.flaticon.com/512/3774/3774299.png' }}" class="w-12 h-12 rounded-full object-cover border border-gray-100"><div><h4 class="font-bold text-sm">{{ d.nome }}</h4><p class="text-xs text-gray-400">{{ d.especialidade }}</p></div></div><button onclick="abrirModalExclusao('excluir_user', '{{ d.id }}')" type="button" class="text-gray-300 hover:text-red-500"><i class="fas fa-user-times"></i></button></div>{% endfor %}</div></div>
        <div id="clinicas" class="tab-content {{ 'hidden' if active_tab != 'clinicas' else '' }}"><h2 class="text-3xl font-serif font-bold text-luxury-black mb-6">Unidades</h2><div class="bg-white p-6 md:p-8 rounded-[2rem] shadow-sm border border-gray-100 mb-8"><h3 class="text-sm font-bold uppercase tracking-widest text-gold-primary mb-4">Nova Unidade</h3><form method="POST" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end"><input type="hidden" name="acao" value="nova_clinica"><div><label class="text-[10px] font-bold text-gray-400 uppercase">Nome</label><input type="text" name="nome" required class="input-gold"></div><div><label class="text-[10px] font-bold text-gray-400 uppercase">Bairro</label><input type="text" name="bairro" required class="input-gold"></div><div><label class="text-[10px] font-bold text-gray-400 uppercase">Endereço</label><input type="text" name="endereco" required class="input-gold"></div><div><label class="text-[10px] font-bold text-gray-400 uppercase">Telefone</label><input type="text" name="telefone" required class="input-gold"></div><button class="bg-luxury-black text-white h-[46px] rounded-lg font-bold uppercase text-xs hover:bg-luxury-gold transition lg:col-span-4 mt-2">Adicionar Unidade</button></form></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{% for clinica in clinicas %}<div class="bg-white p-6 rounded-[2rem] border border-gray-100 relative group hover:shadow-lg transition"><div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition"><button onclick="abrirModalExclusao('excluir_clinica', '{{ clinica.id }}')" type="button" class="text-red-300 hover:text-red-600 bg-red-50 p-2 rounded-full"><i class="fas fa-trash-alt"></i></button></div><h4 class="font-bold text-lg mb-1">{{ clinica.nome }}</h4><span class="bg-luxury-gold/10 text-luxury-gold text-[10px] font-bold px-2 py-0.5 rounded uppercase">{{ clinica.bairro }}</span><div class="mt-4 space-y-2 text-sm text-gray-500"><p><i class="fas fa-map-marker-alt w-5 text-center"></i> {{ clinica.endereco_completo }}</p><p><i class="fas fa-phone w-5 text-center"></i> {{ clinica.telefone }}</p></div></div>{% endfor %}</div></div>
        
        <div id="site" class="tab-content {{ 'hidden' if active_tab != 'site' else '' }}">
            <h2 class="text-3xl font-serif font-bold text-luxury-black mb-6">Editor do Site</h2>
            <form method="POST" enctype="multipart/form-data" class="bg-white p-8 rounded-[2rem] shadow-sm border border-gray-100 space-y-8">
                <input type="hidden" name="acao" value="config_site">

                <div>
                    <h3 class="text-sm font-bold uppercase tracking-widest text-gold-primary mb-4 border-b border-gray-100 pb-2">Fotos da Home</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Foto: Sua Próxima Visita</label>
                            <input type="file" name="img_visita" class="input-gold pt-2 text-xs">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Foto: Ver Equipe</label>
                            <input type="file" name="img_especialistas" class="input-gold pt-2 text-xs">
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-sm font-bold uppercase tracking-widest text-gold-primary mb-4 border-b border-gray-100 pb-2">Dados do Rodapé</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase">Telefone</label><input type="text" name="rodape_tel" value="{{ config.rodape_tel }}" class="input-gold"></div>
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase">Email</label><input type="text" name="rodape_email" value="{{ config.rodape_email }}" class="input-gold"></div>
                        <div class="md:col-span-2"><label class="text-[10px] font-bold text-gray-400 uppercase">Descrição da Marca</label><textarea name="rodape_desc" rows="2" class="input-gold">{{ config.rodape_desc }}</textarea></div>
                        <div class="md:col-span-2"><label class="text-[10px] font-bold text-gray-400 uppercase">Endereço / Copy</label><input type="text" name="rodape_copy" value="{{ config.rodape_copy }}" class="input-gold"></div>
                    </div>
                </div>

                <button class="bg-luxury-black text-white px-8 py-4 rounded-xl font-bold uppercase text-xs hover:bg-luxury-gold transition shadow-lg w-full md:w-auto">Salvar Alterações</button>
            </form>
        </div>

    </main>

    <nav class="md:hidden fixed bottom-0 w-full bg-white border-t border-gray-200 flex justify-around py-3 z-50">
        <button id="mob-dashboard" onclick="openTab('dashboard')" class="mobile-link text-gray-400 flex flex-col items-center"><i class="fas fa-chart-pie text-lg"></i><span class="text-[9px] font-bold mt-1">Dash</span></button>
        <button id="mob-agenda" onclick="openTab('agenda')" class="mobile-link text-gray-400 flex flex-col items-center"><i class="far fa-calendar-alt text-lg"></i><span class="text-[9px] font-bold mt-1">Agenda</span></button>
        <button id="mob-historico" onclick="openTab('historico')" class="mobile-link text-gray-400 flex flex-col items-center"><i class="fas fa-file-medical-alt text-lg"></i><span class="text-[9px] font-bold mt-1">Histórico</span></button>
        <button id="mob-equipe" onclick="openTab('equipe')" class="mobile-link text-gray-400 flex flex-col items-center"><i class="fas fa-user-md text-lg"></i><span class="text-[9px] font-bold mt-1">Equipe</span></button>
    </nav>

    <div id="modal-prontuario" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-[2rem] overflow-hidden shadow-2xl animate-fade-in-up flex flex-col max-h-[80vh]">
            <div class="bg-luxury-black p-6 flex justify-between items-center text-white shrink-0">
                <div><h3 class="font-serif text-xl">Prontuário Completo</h3><p class="text-xs text-luxury-gold uppercase tracking-widest" id="modal-paciente">Nome do Paciente</p></div>
                <div class="flex gap-2">
                    <input type="date" id="filtro_data_modal" onchange="filtrarProntuarioPorData()" class="bg-white text-black text-xs rounded-lg p-2 focus:outline-none border border-gray-300">
                    <button type="button" onclick="fecharModal()" class="text-white/50 hover:text-white transition"><i class="fas fa-times text-xl"></i></button>
                </div>
            </div>
            <div class="p-8 overflow-y-auto" id="lista-prontuarios"></div>
            <div class="p-6 bg-gray-50 text-right shrink-0"><button type="button" onclick="fecharModal()" class="text-xs font-bold uppercase text-gray-500 hover:text-black transition">Fechar Visualização</button></div>
        </div>
    </div>

    <div id="modal-confirm-cancel" class="fixed inset-0 z-50 bg-black/90 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-8 text-center animate-fade-in-up border-t-4 border-luxury-gold">
            <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fas fa-exclamation-triangle"></i></div>
            <h3 class="text-xl font-serif font-bold text-gray-900 mb-2">Cancelar Consulta?</h3>
            <p class="text-sm text-gray-500 mb-6">Esta ação não pode ser desfeita.</p>
            <form method="POST">
                <input type="hidden" name="acao" value="cancelar_consulta"><input type="hidden" name="id_agendamento" id="id_cancelamento">
                <div class="grid grid-cols-2 gap-3">
                    <button type="button" onclick="fecharModalCancelar()" class="py-3 border border-gray-200 rounded-xl text-gray-500 font-bold text-xs hover:bg-gray-50 transition">VOLTAR</button>
                    <button type="submit" class="py-3 bg-red-600 text-white rounded-xl font-bold text-xs hover:bg-red-700 transition shadow-lg">SIM, CANCELAR</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="modal-confirm-delete" class="fixed inset-0 z-50 bg-black/90 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-8 text-center animate-fade-in-up border-t-4 border-red-500">
            <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fas fa-trash-alt"></i></div>
            <h3 class="text-xl font-serif font-bold text-gray-900 mb-2">Confirmação de Exclusão</h3>
            <p class="text-sm text-gray-500 mb-6" id="msg_exclusao">Tem certeza que deseja excluir este item?</p>
            <form method="POST">
                <input type="hidden" name="acao" id="acao_exclusao">
                <input type="hidden" name="id_user" id="id_user_exclusao">
                <input type="hidden" name="id_clinica" id="id_clinica_exclusao">
                
                <div class="grid grid-cols-2 gap-3">
                    <button type="button" onclick="fecharModalExclusao()" class="py-3 border border-gray-200 rounded-xl text-gray-500 font-bold text-xs hover:bg-gray-50 transition">VOLTAR</button>
                    <button type="submit" class="py-3 bg-red-600 text-white rounded-xl font-bold text-xs hover:bg-red-700 transition shadow-lg">SIM, EXCLUIR</button>
                </div>
            </form>
        </div>
    </div>

    {% if link_wpp %}
    <div id="modal-whatsapp" class="fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center animate-fade-in-up">
            <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl"><i class="fab fa-whatsapp"></i></div>
            <h3 class="font-serif text-xl font-bold mb-2">Consulta Cancelada</h3>
            <p class="text-sm text-gray-500 mb-6">A consulta de <strong>{{ nome_cancelado }}</strong> foi cancelada. Deseja notificar o paciente agora?</p>
            <div class="space-y-3">
                <a href="{{ link_wpp }}" target="_blank" onclick="fecharModalWpp()" class="block w-full bg-green-600 text-white py-3 rounded-xl font-bold uppercase text-xs hover:bg-green-700 transition">Enviar Mensagem</a>
                <button onclick="fecharModalWpp()" class="block w-full border border-gray-200 text-gray-400 py-3 rounded-xl font-bold uppercase text-xs hover:bg-gray-50 transition">Agora Não</button>
            </div>
        </div>
    </div>
    {% endif %}

    <script>
        const allDentistas = {{ dentistas_js | tojson }};
        const ocupadosAdmin = {{ ocupados_admin | tojson }};
        
        // Passa folgas para o JS (Fixas e Bloqueios)
        // Precisamos tratar a lista para que o JS entenda
        const folgasPorDentista = {};
        {% for d in dentistas %}
            folgasPorDentista["{{ d.id }}"] = {
                fixas: "{{ d.dia_folga_semanal if d.dia_folga_semanal else '' }}",
                bloqueios: [
                    {% for f in d.folgas %}
                        "{{ f.data.strftime('%Y-%m-%d') }}",
                    {% endfor %}
                ]
            };
        {% endfor %}

        // CORREÇÃO DATA LOCAL (FUSO BRASÍLIA)
        const nowBrasilia = new Date(new Date().toLocaleString("en-US", {timeZone: "America/Sao_Paulo"}));
        
        const year = nowBrasilia.getFullYear();
        const month = String(nowBrasilia.getMonth() + 1).padStart(2, '0');
        const day = String(nowBrasilia.getDate()).padStart(2, '0');
        const todayISO = `${year}-${month}-${day}`; 

        document.addEventListener("DOMContentLoaded", function() {
            const activeTab = "{{ active_tab }}";
            if (activeTab) openTab(activeTab);
            
            // Define data mínima como HOJE DE BRASÍLIA
            const dataInput = document.getElementById('data_agenda');
            if(dataInput) dataInput.setAttribute('min', todayISO);
            
            // Ativa validação inicial
            filtrarMedicosAgenda(); // Para carregar dentistas da primeira clínica
        });

        function filtrarMedicosAgenda() {
            const clinicaId = document.getElementById('clinica_agenda').value;
            const docSelect = document.getElementById('dentista_agenda');
            docSelect.innerHTML = '<option value="">Selecione o Médico...</option>';
            docSelect.disabled = false;
            
            allDentistas.filter(d => d.clinica_id == clinicaId).forEach(d => {
                let opt = document.createElement('option'); opt.value = d.id; opt.innerText = d.nome; docSelect.appendChild(opt);
            });
            atualizarHorariosAgenda(); // Limpa horários ao mudar clínica
        }

        function atualizarHorariosAgenda() {
            const dataInput = document.getElementById('data_agenda');
            const docSelect = document.getElementById('dentista_agenda');
            const timeSelect = document.getElementById('hora_agenda');
            
            if(!dataInput || !docSelect || !timeSelect) return;

            const selectedDate = dataInput.value;
            const selectedDoc = docSelect.value;
            
            // RESET ESTILOS
            dataInput.classList.remove('blocked-input');
            timeSelect.classList.remove('blocked-input');
            timeSelect.disabled = false;
            
            // 1. Recria opções originais
            timeSelect.innerHTML = `
                <option value="08:00">08:00</option><option value="09:00">09:00</option>
                <option value="10:00">10:00</option><option value="11:00">11:00</option>
                <option value="13:00">13:00</option><option value="14:00">14:00</option>
                <option value="15:00">15:00</option><option value="16:00">16:00</option>
                <option value="17:00">17:00</option>
            `;

            if (!selectedDate || !selectedDoc) return;
            
            // 2. VERIFICAÇÃO DE BLOQUEIO (DATA ESPECÍFICA)
            if (folgasPorDentista[selectedDoc] && folgasPorDentista[selectedDoc].bloqueios.includes(selectedDate)) {
                dataInput.classList.add('blocked-input');
                timeSelect.classList.add('blocked-input');
                timeSelect.disabled = true;
                timeSelect.innerHTML = '<option>Dia Bloqueado</option>';
                return;
            }

            // 3. VERIFICAÇÃO DE FOLGA SEMANAL
            const dateObj = new Date(selectedDate + "T00:00:00");
            let dayOfWeek = dateObj.getDay(); 
            let pyDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

            if (folgasPorDentista[selectedDoc] && folgasPorDentista[selectedDoc].fixas.split(',').includes(pyDay.toString())) {
                dataInput.classList.add('blocked-input');
                timeSelect.classList.add('blocked-input');
                timeSelect.disabled = true;
                timeSelect.innerHTML = '<option>Folga Médica</option>';
                return;
            }

            // 4. Lógica de Horários (Passado / 18h)
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "America/Sao_Paulo"}));
            const currentHour = now.getHours();
            
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.getFullYear() + '-' + 
                                String(tomorrow.getMonth() + 1).padStart(2, '0') + '-' + 
                                String(tomorrow.getDate()).padStart(2, '0');

            // Regra do Passado (Se for HOJE)
            if(selectedDate === todayISO) {
                 for(let i=0; i < timeSelect.options.length; i++) {
                    const val = parseInt(timeSelect.options[i].value.split(':')[0]); 
                    if (val <= currentHour) {
                        timeSelect.options[i].disabled = true;
                        timeSelect.options[i].style.color = "#ccc";
                        timeSelect.options[i].innerText += " (Passado)";
                    }
                }
            }

            // Regra das 18h (Se for AMANHÃ)
            if(selectedDate === tomorrowStr && currentHour >= 18) {
                for(let i=0; i < timeSelect.options.length; i++) {
                    const val = timeSelect.options[i].value;
                    if(val === "08:00" || val === "09:00") {
                        timeSelect.options[i].disabled = true;
                        timeSelect.options[i].style.color = "#ccc";
                        timeSelect.options[i].innerText += " (Fechado)";
                    }
                }
            }
            
            // 5. BLOQUEIO DE OCUPADOS (BANCO DE DADOS)
            ocupadosAdmin.forEach(ag => {
                if (String(ag.d) === String(selectedDoc) && ag.dt === selectedDate) {
                    for(let i=0; i < timeSelect.options.length; i++) {
                        if (timeSelect.options[i].value.substring(0, 5) === ag.h) {
                            timeSelect.options[i].disabled = true; 
                            timeSelect.options[i].style.color = "#ccc"; 
                            timeSelect.options[i].innerText = timeSelect.options[i].value.substring(0, 5) + " (Ocupado)";
                        }
                    }
                }
            });
        }
        
        function fecharModalWpp() {
            document.getElementById('modal-whatsapp').classList.add('hidden');
        }
    </script>
</body>
</html>