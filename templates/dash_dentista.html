<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Painel Médico | Exclusive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gold-border { border-color: #bf9b30; }
        .gold-text { color: #bf9b30; }
        .gold-bg { background-color: #bf9b30; }
        
        .radio-card:checked + div {
            border-color: #bf9b30;
            background-color: #fffbeb;
            color: #bf9b30;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .fade-out { animation: fadeOut 1s forwards; animation-delay: 5s; }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; visibility: hidden; } }

        .input-locked { background: transparent; border: none; font-weight: 600; color: #374151; }
        .input-editable { background: #fff; border: 1px solid #e5e7eb; padding: 0.5rem; }
        .input-editable:focus { border-color: #bf9b30; outline: none; }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        body { padding-bottom: 90px; background-color: #f8fafc; } 
    </style>
</head>
<body class="font-sans text-gray-800 flex flex-col md:flex-row min-h-screen">

    <aside class="w-64 bg-white shadow-xl z-20 hidden md:flex flex-col fixed inset-y-0 left-0 h-full border-r border-gray-100 overflow-y-auto">
        <div class="flex-1">
            <div class="p-8 text-center border-b border-gray-50">
                <h1 class="font-serif text-xl font-bold tracking-widest text-gray-900">L'ODONTOLOGIE</h1>
                <p class="text-[10px] text-[#bf9b30] uppercase tracking-[0.3em] mt-1 font-bold">Specialist</p>
            </div>
            
            <div class="p-6 text-center">
                <div class="relative w-20 h-20 mx-auto mb-3">
                    <img src="{{ current_user.foto_perfil }}" class="w-full h-full rounded-full object-cover border-[3px] gold-border shadow-xl">
                </div>
                <p class="font-serif font-bold text-base text-gray-800">Dr(a). {{ current_user.nome }}</p>
                <p class="text-xs text-gray-400 uppercase tracking-wide mt-1">{{ current_user.especialidade or 'Dentista' }}</p>
            </div>

            <nav class="mt-2 px-4 space-y-1 pb-6">
                <a onclick="showTab('agenda')" class="cursor-pointer block p-3 text-sm font-bold text-gray-500 hover:text-black hover:bg-gray-50 rounded-lg transition flex items-center gap-3 desktop-link" id="nav-agenda">
                    <div class="w-8 h-8 flex items-center justify-center bg-gray-50 rounded-md"><i class="fas fa-calendar-check"></i></div>
                    Minha Agenda
                </a>
                <a onclick="showTab('agendar')" class="cursor-pointer block p-3 text-sm font-bold text-gray-500 hover:text-black hover:bg-gray-50 rounded-lg transition flex items-center gap-3 desktop-link" id="nav-agendar">
                    <div class="w-8 h-8 flex items-center justify-center bg-gray-50 rounded-md"><i class="fas fa-user-plus"></i></div>
                    Novo Paciente
                </a>
                <a onclick="showTab('emergencia')" class="cursor-pointer block p-3 text-sm font-bold text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition flex items-center gap-3 desktop-link" id="nav-emergencia">
                    <div class="w-8 h-8 flex items-center justify-center bg-red-50 text-red-500 rounded-md"><i class="fas fa-ban"></i></div>
                    Bloqueio
                </a>
                <a onclick="showTab('portfolio')" class="cursor-pointer block p-3 text-sm font-bold text-gray-500 hover:text-black hover:bg-gray-50 rounded-lg transition flex items-center gap-3 desktop-link" id="nav-portfolio">
                    <div class="w-8 h-8 flex items-center justify-center bg-gray-50 rounded-md"><i class="fas fa-camera"></i></div>
                    Portfólio
                </a>
                <a onclick="showTab('perfil')" class="cursor-pointer block p-3 text-sm font-bold text-gray-500 hover:text-black hover:bg-gray-50 rounded-lg transition flex items-center gap-3 desktop-link" id="nav-perfil">
                    <div class="w-8 h-8 flex items-center justify-center bg-gray-50 rounded-md"><i class="fas fa-user-md"></i></div>
                    Meu Perfil
                </a>
            </nav>
        </div>
        
        <div class="p-6 border-t border-gray-50 mt-auto">
            <a href="/logout" class="block w-full text-center py-2 text-xs font-bold text-red-400 hover:text-red-600 border border-red-100 hover:bg-red-50 rounded-lg transition tracking-widest">
                DESCONECTAR
            </a>
        </div>
    </aside>

    <div class="md:hidden bg-white/90 backdrop-blur-md p-4 shadow-sm flex justify-between items-center sticky top-0 z-40 border-b border-gray-100">
        <div class="flex items-center gap-3">
            <img src="{{ current_user.foto_perfil }}" class="w-10 h-10 rounded-full border border-gray-200 object-cover shadow-sm">
            <div>
                <p class="text-[10px] text-[#bf9b30] font-bold uppercase tracking-widest">Painel Médico</p>
                <p class="text-sm font-bold leading-none">{{ current_user.nome.split()[0] }}</p>
            </div>
        </div>
        <a href="/logout" class="text-gray-400 hover:text-red-500"><i class="fas fa-sign-out-alt text-lg"></i></a>
    </div>

    <main class="flex-1 md:ml-64 p-4 md:p-12 max-w-[1600px] mx-auto w-full">
        
        {% if afetados %}
        <div class="bg-red-50 border-l-4 border-red-500 p-6 mb-8 rounded-xl shadow-lg">
            <h2 class="text-lg font-bold text-red-800 mb-4 flex items-center gap-2">
                <i class="fas fa-exclamation-circle"></i> AÇÃO NECESSÁRIA: Avise os pacientes!
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for p in afetados %}
                <div class="bg-white p-4 rounded-lg shadow-sm flex justify-between items-center">
                    <p class="font-bold text-gray-800 text-sm">{{ p.nome }}</p>
                    <a href="{{ p.link }}" target="_blank" class="bg-green-500 text-white px-4 py-2 rounded-full font-bold text-xs hover:bg-green-600 transition flex items-center gap-2">
                        <i class="fab fa-whatsapp text-lg"></i> Avisar
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if whatsapp_link %}
        <div class="fade-out bg-green-50 border-l-4 border-green-500 p-5 mb-8 rounded-xl shadow-lg flex flex-col md:flex-row justify-between items-center gap-4 animate-pulse">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600"><i class="fas fa-check"></i></div>
                <div>
                    <p class="font-bold text-green-900">Cancelamento Processado</p>
                    <p class="text-xs text-green-700">Clique para avisar.</p>
                </div>
            </div>
            <a href="{{ whatsapp_link }}" target="_blank" class="w-full md:w-auto bg-green-600 text-white px-6 py-3 rounded-lg font-bold text-xs shadow-lg hover:bg-green-700 transition flex items-center justify-center gap-2">
                <i class="fab fa-whatsapp text-lg"></i> Enviar Mensagem
            </a>
        </div>
        {% endif %}

        {% if erro %}<div class="fade-out fixed top-6 right-6 z-50 bg-white border-l-4 border-red-500 text-red-700 p-4 rounded-xl shadow-2xl flex items-center gap-3"><i class="fas fa-times-circle text-xl"></i><div><p class="font-bold text-sm">Atenção</p><p class="text-xs">{{ erro }}</p></div></div>{% endif %}
        {% if sucesso and not whatsapp_link and not afetados %}<div class="fade-out fixed top-6 right-6 z-50 bg-white border-l-4 border-green-500 text-green-800 p-4 rounded-xl shadow-2xl flex items-center gap-3"><i class="fas fa-check-circle text-xl"></i><div><p class="font-bold text-sm">Sucesso</p><p class="text-xs">{{ sucesso }}</p></div></div>{% endif %}

        <div id="agenda" class="tab-content">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-serif font-bold text-gray-900">Gestão de Agenda</h2>
                <div class="text-right">
                    <p class="text-xs text-gray-400 uppercase tracking-widest">Data de Hoje</p>
                    <p class="font-bold text-lg" id="data-atual-display">Carregando...</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 h-fit">
                    <div class="flex items-center gap-3 mb-6 border-b border-gray-50 pb-4">
                        <span class="w-3 h-3 rounded-full bg-green-500 shadow-green-500/50 shadow-lg"></span>
                        <h3 class="font-bold text-gray-800 tracking-wide">ATENDIMENTOS HOJE</h3>
                        <span class="ml-auto bg-gray-100 text-xs font-bold px-2 py-1 rounded-md text-gray-500">{{ agenda_hoje|length }}</span>
                    </div>
                    <div class="space-y-4">
                        {% for item in agenda_hoje %}
                        <div class="relative bg-white border border-gray-100 p-4 rounded-2xl shadow-sm hover:shadow-md transition group {% if item.tipo_consulta == 'Avaliação' %} border-l-4 border-l-[#bf9b30] {% else %} border-l-4 border-l-gray-300 {% endif %}">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center gap-3">
                                    <img src="{{ item.paciente.foto_perfil }}" class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm bg-gray-100">
                                    <div>
                                        <p class="font-bold text-sm leading-tight">{{ item.paciente.nome.split()[0] }}</p>
                                        {% if item.tipo_consulta == 'Avaliação' %}
                                            <span class="bg-[#bf9b30] text-white text-[9px] px-2 py-0.5 rounded font-bold uppercase tracking-wider shadow-sm">1ª VEZ</span>
                                        {% else %}
                                            <p class="text-[10px] text-gray-400 uppercase font-bold">{{ item.tipo_consulta }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                                <span class="text-xl font-bold text-gray-800 font-serif">{{ item.data_hora.strftime('%H:%M') }}</span>
                            </div>
                            <div class="bg-gray-50 p-2 rounded-lg mb-3">
                                <p class="text-xs text-gray-500 font-medium"><i class="fas fa-tooth text-[#bf9b30] mr-1"></i> {{ item.servico }}</p>
                                {% if item.observacoes %}
                                <p class="text-[10px] text-gray-400 mt-2 italic border-t border-gray-200 pt-1">
                                    <i class="fas fa-sticky-note mr-1"></i> {{ item.observacoes }}
                                </p>
                                {% endif %}
                            </div>
                            <div class="flex gap-2">
                                <a href="https://wa.me/55{{ item.paciente.telefone }}" target="_blank" class="flex-1 bg-green-50 text-green-600 py-2 rounded-lg text-center hover:bg-green-500 hover:text-white transition"><i class="fab fa-whatsapp"></i></a>
                                <form method="POST" class="flex-1" onsubmit="return confirm('Cancelar consulta de hoje?')">
                                    <input type="hidden" name="acao" value="cancelar_consulta">
                                    <input type="hidden" name="id_agendamento" value="{{ item.id }}">
                                    <button class="w-full py-2 bg-red-50 text-red-500 rounded-lg hover:bg-red-500 hover:text-white transition"><i class="fas fa-times"></i></button>
                                </form>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center py-10 opacity-50">
                            <i class="far fa-calendar-check text-4xl text-gray-300 mb-2"></i>
                            <p class="text-xs font-bold text-gray-400">Tudo livre por hoje.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 h-fit opacity-90">
                    <div class="flex items-center gap-3 mb-6 border-b border-gray-50 pb-4">
                        <span class="w-3 h-3 rounded-full bg-blue-400"></span>
                        <h3 class="font-bold text-gray-800 tracking-wide">AMANHÃ</h3>
                        <span id="count-amanha" class="ml-auto bg-gray-100 text-xs font-bold px-2 py-1 rounded-md text-gray-500">0</span>
                    </div>
                    <div id="lista-amanha" class="space-y-4">
                        <div class="text-center py-10 opacity-50 empty-msg"><p class="text-xs font-bold text-gray-400">Sem agendamentos.</p></div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 h-fit opacity-75">
                    <div class="flex items-center gap-3 mb-6 border-b border-gray-50 pb-4">
                        <span class="w-3 h-3 rounded-full bg-gray-300"></span>
                        <h3 class="font-bold text-gray-800 tracking-wide">FUTURO</h3>
                        <span id="count-futuro" class="ml-auto bg-gray-100 text-xs font-bold px-2 py-1 rounded-md text-gray-500">0</span>
                    </div>
                    <div id="lista-futuro" class="space-y-4">
                        <div class="text-center py-10 opacity-50 empty-msg"><p class="text-xs font-bold text-gray-400">Agenda futura livre.</p></div>
                    </div>
                </div>

                <div id="dados-futuros" class="hidden">
                    {% for item in agenda_futura %}
                    <div class="agenda-item relative bg-white border border-gray-100 p-4 rounded-2xl shadow-sm" data-date="{{ item.data_hora.strftime('%Y-%m-%d') }}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-3">
                                <img src="{{ item.paciente.foto_perfil }}" class="w-10 h-10 rounded-full object-cover bg-gray-100">
                                <div>
                                    <p class="font-bold text-sm">{{ item.paciente.nome.split()[0] }}</p>
                                    <p class="text-[10px] text-gray-400">{{ item.data_hora.strftime('%d/%m') }} às {{ item.data_hora.strftime('%H:%M') }}</p>
                                </div>
                            </div>
                            {% if item.tipo_consulta == 'Avaliação' %}
                            <span class="bg-[#bf9b30] text-white text-[9px] px-2 py-1 rounded font-bold uppercase">1ª Vez</span>
                            {% endif %}
                        </div>
                        <p class="text-xs text-gray-500 mb-2 ml-13 pl-1">{{ item.servico }}</p>
                        {% if item.observacoes %}
                        <p class="text-[9px] text-gray-400 mb-3 ml-13 pl-1 italic border-l-2 border-gray-200 pl-2">
                            {{ item.observacoes }}
                        </p>
                        {% endif %}
                        <form method="POST" onsubmit="return confirm('Cancelar?')">
                            <input type="hidden" name="acao" value="cancelar_consulta">
                            <input type="hidden" name="id_agendamento" value="{{ item.id }}">
                            <button class="w-full text-xs font-bold text-red-300 hover:text-red-500 py-1 border-t border-gray-50">CANCELAR</button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div id="agendar" class="tab-content hidden">
            <h2 class="text-3xl font-serif font-bold mb-2">Agendar Paciente</h2>
            <p class="text-sm text-gray-500 mb-8">Selecione o motivo da consulta.</p>
            
            <form method="POST" class="max-w-5xl mx-auto">
                <input type="hidden" name="acao" value="agendar">
                
                <p class="text-xs font-bold uppercase text-gray-400 mb-4 tracking-wider">Qual o motivo da visita?</p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <label class="cursor-pointer group">
                        <input type="radio" name="servico" value="Avaliação Geral" class="hidden radio-card" required checked>
                        <div class="border-2 border-gray-100 bg-white p-4 rounded-2xl text-center hover:border-gray-300 transition group-hover:shadow-lg h-full flex flex-col items-center justify-center gap-3">
                            <i class="fas fa-clipboard-list text-2xl text-gray-300 group-hover:text-[#bf9b30] transition"></i>
                            <span class="text-xs font-bold text-gray-600 group-hover:text-black">Avaliação</span>
                        </div>
                    </label>
                    <label class="cursor-pointer group">
                        <input type="radio" name="servico" value="Dor / Urgência" class="hidden radio-card">
                        <div class="border-2 border-gray-100 bg-white p-4 rounded-2xl text-center hover:border-gray-300 transition group-hover:shadow-lg h-full flex flex-col items-center justify-center gap-3">
                            <i class="fas fa-first-aid text-2xl text-gray-300 group-hover:text-red-500 transition"></i>
                            <span class="text-xs font-bold text-gray-600 group-hover:text-black">Urgência</span>
                        </div>
                    </label>
                    <label class="cursor-pointer group">
                        <input type="radio" name="servico" value="Estética" class="hidden radio-card">
                        <div class="border-2 border-gray-100 bg-white p-4 rounded-2xl text-center hover:border-gray-300 transition group-hover:shadow-lg h-full flex flex-col items-center justify-center gap-3">
                            <i class="fas fa-gem text-2xl text-gray-300 group-hover:text-blue-500 transition"></i>
                            <span class="text-xs font-bold text-gray-600 group-hover:text-black">Estética</span>
                        </div>
                    </label>
                    <label class="cursor-pointer group">
                        <input type="radio" name="servico" value="Ortodontia" class="hidden radio-card">
                        <div class="border-2 border-gray-100 bg-white p-4 rounded-2xl text-center hover:border-gray-300 transition group-hover:shadow-lg h-full flex flex-col items-center justify-center gap-3">
                            <i class="fas fa-teeth text-2xl text-gray-300 group-hover:text-gray-600 transition"></i>
                            <span class="text-xs font-bold text-gray-600 group-hover:text-black">Ortodontia</span>
                        </div>
                    </label>
                </div>

                <div class="bg-white p-8 rounded-3xl shadow-xl border border-gray-100">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
                        
                        <div>
                            <label class="block text-xs font-bold uppercase text-gray-400 mb-2">Busca (Email ou Tel)</label>
                            <div class="relative">
                                <input type="text" name="termo_busca" id="termo_busca" required placeholder="Digite e-mail ou telefone..." class="w-full bg-gray-50 border-2 border-gray-100 text-xl font-bold p-3 pl-10 rounded-xl focus:border-[#bf9b30] focus:bg-white outline-none transition-colors">
                                <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold uppercase text-gray-400 mb-2">Nome (Conferência)</label>
                            <input type="text" placeholder="Preenchimento automático..." class="w-full bg-gray-50 border-2 border-gray-100 text-xl p-3 rounded-xl cursor-not-allowed" disabled>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div>
                            <label class="block text-xs font-bold uppercase text-gray-400 mb-2">Data</label>
                            <input type="date" name="data_dia" required class="w-full bg-white border border-gray-200 text-sm rounded-lg p-3 focus:border-[#bf9b30] outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-gray-400 mb-2">Horário</label>
                            <select name="data_hora" class="w-full bg-white border border-gray-200 text-sm rounded-lg p-3 focus:border-[#bf9b30] outline-none">
                                <optgroup label="Manhã">
                                    <option value="08:00">08:00</option>
                                    <option value="09:00">09:00</option>
                                    <option value="10:00">10:00</option>
                                    <option value="11:00">11:00</option>
                                </optgroup>
                                <optgroup label="Tarde">
                                    <option value="13:00">13:00</option>
                                    <option value="14:00">14:00</option>
                                    <option value="15:00">15:00</option>
                                    <option value="16:00">16:00</option>
                                    <option value="17:00">17:00</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-gray-400 mb-2">Tipo de Consulta</label>
                            <select name="tipo_consulta" class="w-full bg-white border border-gray-200 text-sm rounded-lg p-3 focus:border-[#bf9b30] outline-none">
                                <option value="Avaliação">Avaliação (1ª Vez)</option>
                                <option value="Tratamento">Tratamento</option>
                                <option value="Retorno">Retorno</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-xs font-bold uppercase text-gray-400 mb-2">Observações / Rascunho</label>
                        <textarea name="observacoes" class="w-full bg-gray-50 border-2 border-gray-100 p-3 rounded-xl focus:border-[#bf9b30] focus:bg-white outline-none h-20 resize-none transition-colors" placeholder="Ex: Paciente relatou sensibilidade..."></textarea>
                    </div>

                    <button class="w-full bg-black text-white py-4 rounded-xl font-bold uppercase tracking-widest shadow-xl hover:bg-[#bf9b30] transition transform active:scale-[0.99]">
                        Confirmar Agendamento
                    </button>
                </div>
            </form>
        </div>

        <div id="emergencia" class="tab-content hidden">
            <div class="max-w-2xl bg-white p-10 rounded-3xl shadow-2xl border-2 border-red-50 relative overflow-hidden">
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-red-50 rounded-full blur-3xl opacity-50"></div>
                <h2 class="text-2xl font-bold text-red-600 mb-2 relative z-10 flex items-center gap-3"><span class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-500"><i class="fas fa-ban"></i></span>Bloqueio de Agenda</h2>
                <p class="text-sm text-gray-500 mb-8 relative z-10 ml-12">Esta ação cancelará <strong>todos</strong> os atendimentos do dia selecionado.</p>
                <form method="POST" onsubmit="return confirm('ATENÇÃO: Confirmar o bloqueio cancelará todas as consultas deste dia. Continuar?')">
                    <input type="hidden" name="acao" value="bloqueio">
                    <div class="mb-6"><label class="block text-xs font-bold uppercase text-gray-400 mb-2">Selecione a Data</label><input type="date" name="data_bloqueio" required class="w-full border-b-2 border-gray-200 py-3 text-2xl font-serif font-bold text-gray-800 focus:border-red-500 outline-none bg-transparent"></div>
                    <div class="mb-8"><label class="block text-xs font-bold uppercase text-gray-400 mb-2">Motivo do Bloqueio</label><input type="text" name="motivo" placeholder="Ex: Congresso, Doença, Curso..." class="w-full border-b-2 border-gray-200 py-3 text-lg text-gray-600 focus:border-red-500 outline-none bg-transparent"></div>
                    <button class="w-full bg-red-600 text-white py-4 rounded-xl font-bold uppercase tracking-widest shadow-lg hover:bg-red-700 transition flex items-center justify-center gap-3"><i class="fas fa-lock"></i> Confirmar Bloqueio</button>
                </form>
            </div>
        </div>

        <div id="portfolio" class="tab-content hidden">
            <h2 class="text-2xl font-serif font-bold mb-6">Portfólio</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="bg-white p-8 rounded-2xl shadow-lg border border-gray-100 h-fit">
                    <h3 class="font-bold mb-6 text-lg">Adicionar Novo Caso</h3>
                    <form method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="acao" value="portfolio">
                        <div class="mb-6 relative group cursor-pointer">
                            <div class="border-2 border-dashed border-gray-300 rounded-xl p-10 text-center hover:bg-gray-50 hover:border-[#bf9b30] transition"><i class="fas fa-cloud-upload-alt text-4xl text-gray-300 group-hover:text-[#bf9b30] mb-2 transition"></i><p class="text-xs text-gray-400 font-bold uppercase">Carregar Foto</p></div>
                            <input type="file" name="foto" required class="absolute inset-0 opacity-0 cursor-pointer">
                        </div>
                        <div class="space-y-4">
                            <div><label class="block text-[10px] font-bold uppercase text-gray-400 mb-1">Título</label><input type="text" name="titulo" placeholder="Ex: Facetas" class="w-full border-b border-gray-200 py-2 focus:border-black outline-none font-medium"></div>
                            <div><label class="block text-[10px] font-bold uppercase text-gray-400 mb-1">Descrição</label><textarea name="descricao" placeholder="Detalhes..." class="w-full border-b border-gray-200 py-2 focus:border-black outline-none h-20 text-sm resize-none"></textarea></div>
                        </div>
                        <button class="w-full bg-black text-white py-3 rounded-lg font-bold text-xs uppercase mt-6 shadow hover:bg-[#bf9b30] transition">Publicar</button>
                    </form>
                </div>
                <div class="md:col-span-2">
                    <div class="grid grid-cols-2 gap-4">
                        {% for p in posts %}
                        <div class="relative group h-48 rounded-2xl overflow-hidden shadow-md cursor-pointer">
                            <img src="{{ p.imagem_arquivo }}" class="w-full h-full object-cover transform transition duration-700 group-hover:scale-110">
                            <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition duration-300 flex flex-col justify-center items-center text-white p-4 text-center">
                                <p class="font-bold text-sm mb-1">{{ p.titulo }}</p>
                                <span class="bg-[#bf9b30] text-[9px] px-2 py-1 rounded font-bold uppercase text-black">Publicado</span>
                            </div>
                        </div>
                        {% else %}
                        <div class="col-span-2 text-center py-20 bg-gray-50 rounded-2xl border-2 border-dashed border-gray-200"><p class="text-gray-400">Seu portfólio está vazio.</p></div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div id="perfil" class="tab-content hidden">
            <h2 class="text-2xl font-serif font-bold mb-6">Meu Perfil</h2>
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden relative border border-gray-100">
                <div class="h-32 bg-gray-900 relative">
                    <div class="absolute inset-0 bg-gradient-to-r from-black to-gray-800 opacity-90"></div>
                    <div class="absolute bottom-6 left-8 text-white"><p class="text-[10px] uppercase tracking-widest text-[#bf9b30] font-bold mb-1">Professional ID</p><h3 class="text-xl font-serif">Ficha Técnica</h3></div>
                </div>
                <div class="p-8 relative">
                    <div class="absolute -top-12 right-8 w-24 h-24 rounded-full border-4 border-white shadow-2xl overflow-hidden bg-white">
                        <img src="{{ current_user.foto_perfil }}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3774/3774299.png'" class="w-full h-full object-cover">
                    </div>
                    <form id="form-perfil" method="POST" enctype="multipart/form-data" class="mt-4 space-y-6">
                        <input type="hidden" name="acao" value="perfil">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div><label class="block text-xs font-bold uppercase text-gray-400 mb-1">Nome Profissional</label><input type="text" name="nome" value="{{ current_user.nome }}" disabled class="input-locked w-full border-b border-gray-200 py-2 text-lg text-gray-800"></div>
                            <div><label class="block text-xs font-bold uppercase text-gray-400 mb-1">WhatsApp</label><input type="text" name="telefone" value="{{ current_user.telefone or '' }}" disabled class="input-locked w-full border-b border-gray-200 py-2 text-lg text-gray-800"></div>
                        </div>
                        <div><label class="block text-xs font-bold uppercase text-gray-400 mb-1">Especialidade</label><input type="text" name="especialidade" value="{{ current_user.especialidade or '' }}" disabled class="input-locked w-full border-b border-gray-200 py-2 text-lg text-gray-800"></div>
                        <div id="campo-senha" class="hidden bg-gray-50 p-4 rounded-xl border border-gray-200"><label class="block text-xs font-bold uppercase text-gray-500 mb-2">Redefinir Senha</label><div class="relative"><input type="password" name="senha" id="senha_input" placeholder="Nova senha (opcional)" class="w-full bg-white border border-gray-300 rounded-lg p-3 pr-10 text-sm focus:border-[#bf9b30] outline-none"><i class="fas fa-eye absolute right-3 top-3.5 text-gray-400 cursor-pointer hover:text-black transition" onclick="toggleSenha()"></i></div></div>
                        <div class="group relative z-0 w-full mb-6"><label class="block text-xs font-bold uppercase text-gray-400 mb-1">Biografia</label><textarea name="bio" disabled class="input-locked w-full border-b border-gray-200 py-2 text-gray-600 h-24 resize-none">{{ current_user.bio or '' }}</textarea></div>
                        <div id="campo-foto" class="hidden"><label class="block text-xs font-bold uppercase text-gray-400 mb-2">Atualizar Foto</label><input type="file" name="foto_perfil" class="block w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200"></div>
                        <div class="flex gap-4 pt-6 border-t border-gray-50">
                            <button type="button" id="btn-editar" onclick="ativarEdicao()" class="px-6 py-2.5 border border-gray-300 rounded-lg text-xs font-bold text-gray-600 hover:bg-black hover:text-white hover:border-black transition uppercase tracking-wider"><i class="fas fa-pencil-alt mr-2"></i> Editar Dados</button>
                            <button type="submit" id="btn-salvar" class="hidden px-6 py-2.5 bg-black rounded-lg text-xs font-bold text-white hover:bg-[#bf9b30] transition shadow-lg uppercase tracking-wider">Salvar Alterações</button>
                            <button type="button" id="btn-cancelar" onclick="location.reload()" class="hidden px-6 py-2.5 border border-red-200 rounded-lg text-xs font-bold text-red-500 hover:bg-red-50 transition uppercase tracking-wider">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </main>

    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-50 flex justify-around items-center py-3 border-t border-gray-100 pb-safe">
        <button onclick="showTab('agenda')" class="mobile-link flex flex-col items-center gap-1 text-[#bf9b30] w-1/5"><i class="fas fa-calendar-alt text-lg"></i> <span class="text-[9px] font-bold">AGENDA</span></button>
        <button onclick="showTab('agendar')" class="mobile-link flex flex-col items-center gap-1 text-gray-400 w-1/5"><i class="fas fa-plus-circle text-lg"></i> <span class="text-[9px] font-bold">NOVO</span></button>
        <button onclick="showTab('emergencia')" class="mobile-link flex flex-col items-center gap-1 text-gray-400 w-1/5"><i class="fas fa-ban text-lg"></i> <span class="text-[9px] font-bold">FOLGA</span></button>
        <button onclick="showTab('portfolio')" class="mobile-link flex flex-col items-center gap-1 text-gray-400 w-1/5"><i class="fas fa-camera text-lg"></i> <span class="text-[9px] font-bold">FOTOS</span></button>
        <button onclick="showTab('perfil')" class="mobile-link flex flex-col items-center gap-1 text-gray-400 w-1/5"><i class="fas fa-user-md text-lg"></i> <span class="text-[9px] font-bold">PERFIL</span></button>
    </nav>

    <script>
        // Formatar Data Hoje
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('data-atual-display').innerText = new Date().toLocaleDateString('pt-BR', options);

        // Recupera a aba ativa passada pelo Python (padrão 'agenda')
        const activeTab = "{{ active_tab }}";

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.querySelectorAll('.desktop-link').forEach(link => {
                link.classList.remove('tab-active');
                if(link.getAttribute('onclick').includes(tabId)) link.classList.add('tab-active');
            });
            document.querySelectorAll('.mobile-link').forEach(btn => {
                btn.classList.remove('text-[#bf9b30]', 'text-gray-400');
                if(btn.getAttribute('onclick').includes(tabId)) btn.classList.add('text-[#bf9b30]');
                else btn.classList.add('text-gray-400');
            });
        }

        // Inicia na aba correta
        showTab(activeTab || 'agenda');

        // Lógica para Separar Agenda
        function organizarAgenda() {
            const containerDados = document.getElementById('dados-futuros');
            const listaAmanha = document.getElementById('lista-amanha');
            const listaFuturo = document.getElementById('lista-futuro');
            
            const amanha = new Date();
            amanha.setDate(amanha.getDate() + 1);
            const strAmanha = amanha.toISOString().split('T')[0];

            let countAmanha = 0;
            let countFuturo = 0;

            const itens = containerDados.querySelectorAll('.agenda-item');
            
            itens.forEach(item => {
                const dataItem = item.getAttribute('data-date');
                if (dataItem === strAmanha) {
                    listaAmanha.appendChild(item);
                    countAmanha++;
                } else {
                    listaFuturo.appendChild(item);
                    countFuturo++;
                }
            });

            if(countAmanha > 0) listaAmanha.querySelector('.empty-msg').style.display = 'none';
            if(countFuturo > 0) listaFuturo.querySelector('.empty-msg').style.display = 'none';

            document.getElementById('count-amanha').innerText = countAmanha;
            document.getElementById('count-futuro').innerText = countFuturo;
        }

        organizarAgenda();

        function ativarEdicao() {
            ['nome', 'telefone', 'especialidade', 'bio'].forEach(id => {
                const el = document.querySelector(`[name="${id}"]`);
                if(el) { el.disabled = false; el.classList.remove('input-locked'); el.classList.add('input-editable'); }
            });
            document.getElementById('campo-senha').classList.remove('hidden');
            document.getElementById('campo-foto').classList.remove('hidden');
            document.getElementById('btn-editar').classList.add('hidden');
            document.getElementById('btn-salvar').classList.remove('hidden');
            document.getElementById('btn-cancelar').classList.remove('hidden');
        }

        function toggleSenha() {
            const input = document.getElementById('senha_input');
            const icon = document.querySelector('.fa-eye');
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove('text-gray-400');
                icon.classList.add('text-black');
            } else {
                input.type = "password";
                icon.classList.add('text-gray-400');
                icon.classList.remove('text-black');
            }
        }

        const cpfBusca = document.getElementById('cpf_busca');
        if(cpfBusca){
            cpfBusca.addEventListener('input', e => {
                let v = e.target.value.replace(/\D/g, "").slice(0, 11);
                v = v.replace(/(\d{3})(\d)/, "$1.$2");
                v = v.replace(/(\d{3})(\d)/, "$1.$2");
                v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
                e.target.value = v;
            });
        }

        setTimeout(() => { document.querySelectorAll('.fade-out').forEach(el => el.style.display = 'none'); }, 5000);
    </script>
</body>
</html>